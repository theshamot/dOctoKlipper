V// source: plugin/tempsgraph/js/tempsgraph.js\u000a/*\u000a * View model for OctoPrint-tempsgraph\u000a *\u000a * Author: Robin\u000a * License: MIT\u000a */\u000a\u000a$(function() {\u000a    function TempsgraphViewModel(parameters) {\u000a        var self = this;\u000a\u000a        self.loginState = parameters[0];\u000a        self.settingsViewModel = parameters[1];\u000a\u000a        self._createToolEntry = function() {\u000a            return {\u000a                name: ko.observable(),\u000a                key: ko.observable(),\u000a                actual: ko.observable(0),\u000a                target: ko.observable(0),\u000a                newTarget: ko.observable(),\u000a            }\u000a        };\u000a\u000a        self.tools = ko.observableArray([]);\u000a        self.hasBed = ko.observable(true);\u000a        self.bedTemp = self._createToolEntry();\u000a        self.bedTemp["name"](gettext("Bed"));\u000a        self.bedTemp["key"]("bed");\u000a\u000a        self.hasChamber = ko.observable(false);\u000a        self.chamberTemp = self._createToolEntry();\u000a        self.chamberTemp["name"](gettext("Chamber"));\u000a        self.chamberTemp["key"]("chamber");\u000a\u000a        self.isErrorOrClosed = ko.observable(undefined);\u000a        self.isOperational = ko.observable(undefined);\u000a        self.isPrinting = ko.observable(undefined);\u000a        self.isPaused = ko.observable(undefined);\u000a        self.isError = ko.observable(undefined);\u000a        self.isReady = ko.observable(undefined);\u000a        self.isLoading = ko.observable(undefined);\u000a       \u000a        self.temperature_profiles = self.settingsViewModel.temperature_profiles;\u000a        self.temperature_cutoff = self.settingsViewModel.temperature_cutoff;\u000a        self.ownSettings = {}\u000a        self.heaterOptions = ko.observable({});\u000a        self.prevHeaterKeys = "";\u000a\u000a        self._printerProfileInitialized = false;\u000a        self._currentTemperatureDataBacklog = [];\u000a        self._historyTemperatureDataBacklog = [];\u000a\u000a        self.showFahrenheit = false;\u000a        self.temperatures = [];\u000a\u000a        self.plot = null; // plotly graph\u000a        \u000a        self.defaultColors = {\u000a            background: '#ffffff',\u000a            axises: '#000000'\u000a        }\u000a        self.defaultImageData = {\u000a                                  x: 0.5,\u000a                                  y: 0.9,\u000a                                  sizex: 0.8,\u000a                                  sizey: 0.8,\u000a                                  // desired custom background file must be placed into source directory\u000a                                  source: "../static/img/graph-background.png", // e.g."../static/img/CUSTOM-background.png"\u000a                                  xanchor: "center",\u000a                                  xref: "paper",\u000a                                  yanchor: "center",\u000a                                  yref: "paper"\u000a                                };\u000a        self.subscriptions = [];\u000a\u000a        self._printerProfileUpdated = function() {\u000a            var graphColors = ["red", "orange", "green", "brown", "purple", "fuchsia"];\u000a            var heaterOptions = {};\u000a            var tools = self.tools();\u000a            var color;\u000a\u000a            self.showFahrenheit = (self.settingsViewModel.settings !== undefined )\u000a                     ? self.settingsViewModel.settings.appearance.showFahrenheitAlso()\u000a                     : false;\u000a\u000a            // tools\u000a            var currentProfileData = self.settingsViewModel.printerProfiles.currentProfileData();\u000a            var numExtruders = (currentProfileData ? currentProfileData.extruder.count() : 0);\u000a            var sharedNozzle = (currentProfileData ? currentProfileData.extruder.sharedNozzle() : false);\u000a            if (numExtruders && numExtruders > 1 && !sharedNozzle) {\u000a                // multiple extruders\u000a                for (var extruder = 0; extruder < numExtruders; extruder++) {\u000a                    color = graphColors.shift();\u000a                    if (!color) color = "black";\u000a                    heaterOptions["tool" + extruder] = {name: "T" + extruder, color: color};\u000a\u000a                    if (tools.length <= extruder || !tools[extruder]) {\u000a                        tools[extruder] = self._createToolEntry();\u000a                    }\u000a                    tools[extruder]["name"](gettext("Tool") + " " + extruder);\u000a                    tools[extruder]["key"]("tool" + extruder);\u000a                }\u000a            } else if (numExtruders == 1 || sharedNozzle) {\u000a                // only one extruder, no need to add numbers\u000a                color = graphColors[0];\u000a                heaterOptions["tool0"] = {name: "T", color: color};\u000a\u000a                if (tools.length < 1 || !tools[0]) {\u000a                    tools[0] = self._createToolEntry();\u000a                }\u000a                tools[0]["name"](gettext("Tool"));\u000a                tools[0]["key"]("tool0");\u000a            }\u000a\u000a            // print bed\u000a            if (currentProfileData && currentProfileData.heatedBed()) {\u000a                self.hasBed(true);\u000a                heaterOptions["bed"] = {name: gettext("Bed"), color: "blue"};\u000a            } else {\u000a                self.hasBed(false);\u000a            }\u000a\u000a            if (currentProfileData && currentProfileData.heatedChamber()) {\u000a                self.hasChamber(true);\u000a                heaterOptions["chamber"] = {name: gettext("Chamber"), color: "black"};\u000a            } else {\u000a                self.hasChamber(false);\u000a            }\u000a\u000a            // write back\u000a            self.heaterOptions(heaterOptions);\u000a            self.tools(tools);\u000a\u000a            // reset if necessary\u000a            if(self.prevHeaterKeys != _.keys(self.heaterOptions()).join()) {\u000a                self.temperatures = [];\u000a            }\u000a            self.prevHeaterKeys = _.keys(self.heaterOptions()).join();\u000a\u000a            if (!self._printerProfileInitialized) {\u000a                self._triggerBacklog();\u000a            }\u000a        };\u000a        self.settingsViewModel.printerProfiles.currentProfileData.subscribe(function() {\u000a            //Only update if viewModel is bound\u000a            self._bound && self._printerProfileUpdated();\u000a            // disabled because we don't yet support dynamic changes of these parameters\u000a            /*\u000a            self.settingsViewModel.printerProfiles.currentProfileData().extruder.count.subscribe(self._printerProfileUpdated);\u000a            self.settingsViewModel.printerProfiles.currentProfileData().extruder.sharedNozzle.subscribe(self._printerProfileUpdated);\u000a            self.settingsViewModel.printerProfiles.currentProfileData().heatedBed.subscribe(self._printerProfileUpdated);\u000a            self.settingsViewModel.printerProfiles.currentProfileData().heatedChamber.subscribe(self._printerProfileUpdated);\u000a            */\u000a        });\u000a\u000a        self.fromCurrentData = function(data) {\u000a            self._processStateData(data.state);\u000a            if (!self._printerProfileInitialized) {\u000a                self._currentTemperatureDataBacklog.push(data);\u000a            } else {\u000a                self._processTemperatureUpdateData(data.serverTime, data.temps);\u000a            }\u000a        };\u000a\u000a        self.fromHistoryData = function(data) {\u000a            self._processStateData(data.state);\u000a            if (!self._printerProfileInitialized) {\u000a                self._historyTemperatureDataBacklog.push(data);\u000a            } else {\u000a                self._processTemperatureHistoryData(data.serverTime, data.temps);\u000a            }\u000a        };\u000a\u000a        self._triggerBacklog = function() {\u000a            _.each(self._historyTemperatureDataBacklog, function(data) {\u000a                self._processTemperatureHistoryData(data.serverTime, data.temps);\u000a            });\u000a            _.each(self._currentTemperatureDataBacklog, function(data) {\u000a                self._processTemperatureUpdateData(data.serverTime, data.temps);\u000a            });\u000a            self._historyTemperatureDataBacklog = [];\u000a            self._currentTemperatureDataBacklog = [];\u000a            self._printerProfileInitialized = true;\u000a            \u000a            var bodyBgColor = self.defaultColors.background = $('body').css('backgroundColor');\u000a            var axisesColor = self.defaultColors.axises;\u000a            if(self.selectedBackground && self.selectedBackground() != "Default") {\u000a                bodyBgColor = self.backgroundColor();\u000a            }\u000a            if(self.selectedAxises && self.selectedAxises() != "Default") {\u000a                axisesColor = self.axisesColor();\u000a                }\u000a            var tempDiv = document.getElementById("#temperature-graph");\u000a            if($("#temperature-graph").length)\u000a            {\u000a                $("#temperature-graph").parent().remove();\u000a                $("#temp").prepend('<div class="row-fluid"><div id="div_g"></div></div>');\u000a\u000a                self.plot = document.getElementById("div_g");\u000a                var data = [];\u000a                var heaterKeys = _.keys(self.heaterOptions())\u000a                var heaterOptions = self.heaterOptions()\u000a\u000a                for(var i=0;i<heaterKeys.length;i++) {\u000a                    data.push({\u000a                        x: [],\u000a                        y: [],\u000a                        type: 'scatter',\u000a                        mode: 'lines',\u000a                        line: {\u000a                            width: 6.0,\u000a                            color: pusher.color(heaterOptions[heaterKeys[i]].color).tint(0.7).html()\u000a                        },\u000a                        name: heaterKeys[i]+"_target"\u000a                    });\u000a                    data.push({\u000a                        x: [],\u000a                        y: [],\u000a                        type: 'scatter',\u000a                        mode: 'lines',\u000a                        line: {\u000a                            width: 2.0,\u000a                            color: heaterOptions[heaterKeys[i]].color\u000a                        },\u000a                        name: heaterKeys[i]+"_actual"\u000a                    });\u000a                }\u000a\u000a                for(var i=0,len=0;i<self.temperatures.length;i++) {\u000a                    for(var j=1,len=0;j<self.temperatures[i].length;j++) {\u000a                        data[j-1].x.push(self.temperatures[i][0]);\u000a                        data[j-1].y.push(self.temperatures[i][j]);\u000a                    }\u000a                }\u000a\u000a                var layout = {\u000a                  xaxis: {\u000a                    showgrid: true,\u000a                    zeroline: false,\u000a                    linecolor: 'gray',\u000a                    linewidth: 1,\u000a                    mirror: true,\u000a                    color: axisesColor\u000a                  },\u000a                  yaxis: {\u000a                    range: [0, self.getMaxTemp()],\u000a                    linecolor: 'gray',\u000a                    linewidth: 1,\u000a                    mirror: true,\u000a                    color: axisesColor\u000a                  },\u000a                  images: [\u000a                        {\u000a                          x: 0.5,\u000a                          y: 0.9,\u000a                          sizex: 0.8,\u000a                          sizey: 0.8,\u000a                          // desired custom background file must be placed into source directory\u000a                          source: "../static/img/graph-background.png", // e.g."../static/img/CUSTOM-background.png"\u000a                          xanchor: "center",\u000a                          xref: "paper",\u000a                          yanchor: "center",\u000a                          yref: "paper"\u000a                        }\u000a                      ],\u000a                  margin: {\u000a                    l: 30,\u000a                    r: 30,\u000a                    b: 50,\u000a                    t: 30,\u000a                    pad: 4\u000a                  },\u000a                  //width: 588,\u000a                  height: 400,\u000a                  showlegend: false,\u000a                  hovermode: "x",\u000a                  // dark style support\u000a                  paper_bgcolor: bodyBgColor,\u000a                  plot_bgcolor: bodyBgColor,\u000a                };\u000a\u000a                if(!self.ownSettings.showBackgroundImage())\u000a                {\u000a                    layout['images'] = [];\u000a                }\u000a                else\u000a                {\u000a                    layout['images'] = [self.defaultImageData];\u000a                }\u000a\u000a                if (!self.ownSettings.startWithAutoScale())\u000a                {\u000a                    layout['yaxis']['autorange'] = false;\u000a                    layout['yaxis']['range'] = [0, self.getMaxTemp()];\u000a                }\u000a                else\u000a                {\u000a                    layout['yaxis']['autorange'] = true;\u000a                }\u000a\u000a                // bufgix for z-index of modbar\u000a                $("<style>")\u000a                    .prop("type", "text/css")\u000a                    .html("\u005c\u000a                    .js-plotly-plot .plotly .modebar {\u005c\u000a                        z-index: 999;\u005c\u000a                    }")\u000a                    .appendTo("head");\u000a\u000a                Plotly.plot(self.plot, data, layout);\u000a            }\u000a\u000a        };\u000a\u000a        self._processStateData = function(data) {\u000a            self.isErrorOrClosed(data.flags.closedOrError);\u000a            self.isOperational(data.flags.operational);\u000a            self.isPaused(data.flags.paused);\u000a            self.isPrinting(data.flags.printing);\u000a            self.isError(data.flags.error);\u000a            self.isReady(data.flags.ready);\u000a            self.isLoading(data.flags.loading);\u000a        };\u000a\u000a        self._processTemperatureUpdateData = function(serverTime, data) {\u000a            if (data.length == 0)\u000a                return;\u000a\u000a            var lastData = data[data.length - 1];\u000a\u000a            var tools = self.tools();\u000a            for (var i = 0; i < tools.length; i++) {\u000a                if (lastData.hasOwnProperty("tool" + i)) {\u000a                    tools[i]["actual"](lastData["tool" + i].actual);\u000a                    tools[i]["target"](lastData["tool" + i].target);\u000a                } else {\u000a                    tools[i]["actual"](0);\u000a                    tools[i]["target"](0);\u000a                }\u000a            }\u000a\u000a            if (lastData.hasOwnProperty("bed")) {\u000a                self.bedTemp["actual"](lastData.bed.actual);\u000a                self.bedTemp["target"](lastData.bed.target);\u000a            }\u000a\u000a            if (lastData.hasOwnProperty("chamber")) {\u000a                self.chamberTemp["actual"](lastData.chamber.actual);\u000a                self.chamberTemp["target"](lastData.chamber.target);\u000a            }\u000a\u000a            if (!CONFIG_TEMPERATURE_GRAPH) return;\u000a\u000a            self.temperatures = self._processTemperatureData(serverTime, data, self.temperatures);\u000a        };\u000a\u000a        self._processTemperatureHistoryData = function(serverTime, data) {\u000a            self.temperatures = self._processTemperatureData(serverTime, data);\u000a        };\u000a\u000a        function arraysEqual(arr1, arr2) {\u000a            if(arr1.length !== arr2.length)\u000a                return false;\u000a            for(var i = arr1.length; i--;) {\u000a                if(arr1[i] !== arr2[i])\u000a                    return false;\u000a            }\u000a\u000a            return true;\u000a        }\u000a\u000a\u000a        self._processTemperatureData = function(serverTime, data, result) {\u000a            var types = _.keys(self.heaterOptions());\u000a            var resultSize = types.length*2 + 1;\u000a            var clientTime = Date.now();\u000a\u000a            // make sure result is properly initialized\u000a            if (!result) {\u000a                result = [];\u000a            }\u000a\u000a            var newData = {x:[], y:[]};\u000a\u000a            for(var i=1,len=0;i<resultSize  ;i++) {\u000a                newData.x.push([])\u000a                newData.y.push([])\u000a            }\u000a\u000a\u000a            for(var i=0,len=data.length;i<len;i++) {\u000a                var d = data[i];\u000a                var timeDiff = (serverTime - d.time) * 1000;\u000a                var time = Math.round(clientTime - timeDiff);\u000a                var tuple = [new Date(time)];\u000a\u000a                _.each(types, function(type) {\u000a                    if (d[type])\u000a                    {\u000a                        tuple.push(d[type].target);\u000a                        tuple.push(d[type].actual);\u000a                    }\u000a                    else\u000a                    {\u000a                        tuple.push(NaN);\u000a                        tuple.push(NaN);\u000a                    }\u000a                });\u000a                if(tuple.length == resultSize)\u000a                {\u000a                    result.push(tuple);\u000a\u000a                for(var j=1;j<tuple.length;j++) {\u000a                    newData.x[j-1].push(tuple[0]);\u000a                    newData.y[j-1].push(tuple[j]);\u000a                }\u000a                }\u000a            }\u000a\u000a            // todo : can be done in a more efficient matter, because result[0] is ordered\u000a            var temperature_cutoff = self.temperature_cutoff();\u000a            if (temperature_cutoff != undefined) {\u000a                var filterOld = function(item) {\u000a                    return item[0] >= clientTime - temperature_cutoff * 60 * 1000;\u000a                };\u000a\u000a                result = _.filter(result, filterOld);\u000a            }\u000a\u000a            // update plot\u000a            if(self.plot) {\u000a                var tracesToUpdate = []; // [0,1,2,3,...]\u000a                for(var i=0;i<newData.x.length;i++) {\u000a                    tracesToUpdate.push(i);\u000a                }\u000a\u000a                // update layout\u000a                Plotly.extendTraces(self.plot, newData, tracesToUpdate, result.length)\u000a            }\u000a\u000a            return result;\u000a        };\u000a\u000a        self.getMaxTemp = function(actuals, targets) {\u000a            var maxTemp = 310; // default minimum\u000a\u000a            for(var i=0,len=0;i<self.temperatures.length;i++) {\u000a                for(var j=1,len=0;j<self.temperatures[i].length;j++) {\u000a                    let t = self.temperatures[i][j];\u000a                    if(Number.isFinite(t))\u000a                    {\u000a                        maxTemp = Math.max(t, maxTemp);\u000a                    }\u000a                }\u000a            }\u000a            return maxTemp;\u000a        }\u000a\u000a        self.onStartupComplete = function() {\u000a            // we can't init yet because since octoprint 1.4.0 the correct number of tools is not yet available\u000a            //self._printerProfileUpdated();\u000a        };\u000a\u000a        self.onChangeBackgroundColor = function(val, useDefault) {\u000a            var bgColor = useDefault ? self.defaultColors.background : self.backgroundColor();\u000a            var relayout = {\u000a                paper_bgcolor: bgColor,\u000a                plot_bgcolor: bgColor\u000a            }\u000a            Plotly.relayout(self.plot, relayout);\u000a        }\u000a\u000a        self.onChangeAxisesColor = function(val, useDefault) {\u000a            var aColor = useDefault ? self.defaultColors.axises : self.axisesColor();\u000a            var relayout = {\u000a                'xaxis.color': aColor,\u000a                'yaxis.color': aColor\u000a            }\u000a            Plotly.relayout(self.plot, relayout);\u000a        }\u000a\u000a        self.onShowBackgroundImage = function(val, useDefault) {\u000a            var relayout;\u000a            if(!val)\u000a            {\u000a                relayout = {\u000a                    'images': []\u000a                }\u000a            }\u000a            else\u000a            {\u000a                relayout = {\u000a                    images: [self.defaultImageData]\u000a                }\u000a            }\u000a            Plotly.relayout(self.plot, relayout);\u000a        }\u000a\u000a        self.onStartWithAutoScale = function(val, useDefault) {\u000a            var relayout = {\u000a                'yaxis.autorange': val\u000a            };\u000a            if (!self.ownSettings.startWithAutoScale())\u000a            {\u000a                relayout['yaxis.range'] = [0, self.getMaxTemp()];\u000a            }\u000a            Plotly.relayout(self.plot, relayout);\u000a        }\u000a\u000a        self.onBeforeBinding = function() {\u000a            self.ownSettings = self.settingsViewModel.settings.plugins.tempsgraph;\u000a            self.backgroundColors = self.ownSettings.backgroundPresets;\u000a            self.axisesColors = self.ownSettings.axisesPresets;\u000a            self.selectedBackground = self.ownSettings.color.backgroundColor;\u000a            self.selectedAxises = self.ownSettings.color.axisesColor;\u000a\u000a            //Compute backgroundColor from preset and selected.\u000a            self.backgroundColor = ko.computed({\u000a                read: function() {\u000a                    return self.ownSettings.backgroundPresets()\u000a                    .find(function(preset) {\u000a                        return preset.name() == self.selectedBackground();\u000a                    }).value.extend({ rateLimit: 100})()\u000a                },\u000a                write: function(val) {\u000a                    return self.ownSettings.backgroundPresets()\u000a                    .find(function(preset) {\u000a                        return preset.name() == self.selectedBackground();\u000a                    }).value(val);\u000a                }\u000a            });\u000a            //for color as well\u000a            self.axisesColor = ko.computed({\u000a                read: function() {\u000a                    return self.ownSettings.axisesPresets()\u000a                    .find(function(preset) {\u000a                        return preset.name() == self.selectedAxises();\u000a                    }).value();\u000a                },\u000a                write: function(val) {\u000a                    return self.ownSettings.axisesPresets()\u000a                    .find(function(preset) {\u000a                        return preset.name() == self.selectedAxises();\u000a                    }).value(val);\u000a                }\u000a            });\u000a        }\u000a        \u000a        self.onSettingsShown = function() {\u000a            //subscribe to handlers\u000a            self.subscriptions.push(\u000a                self.backgroundColor.subscribe(self.onChangeBackgroundColor),\u000a                self.axisesColor.subscribe(self.onChangeAxisesColor),\u000a                self.ownSettings.startWithAutoScale.subscribe(self.onStartWithAutoScale),\u000a                self.ownSettings.showBackgroundImage.subscribe(self.onShowBackgroundImage));\u000a        }\u000a\u000a        self.onSettingsHidden = function() {\u000a            //dispose of them\u000a            self.subscriptions.map(function(elem, i) {\u000a                elem.dispose();\u000a            });\u000a        }\u000a    }\u000a\u000a    // view model class, parameters for constructor, container to bind to\u000a    OCTOPRINT_VIEWMODELS.push({\u000a        construct: TempsgraphViewModel,\u000a        dependencies: ["loginStateViewModel", "settingsViewModel"],\u000a        elements: ["#settings_plugin_tempsgraph"]\u000a    });\u000a\u000a});\u000a\u000a\u000a;\u000a
p0
.