V// source: js/app/viewmodels/temperature.js\u000a$(function () {\u000a    function TemperatureViewModel(parameters) {\u000a        var self = this;\u000a\u000a        self.loginState = parameters[0];\u000a        self.settingsViewModel = parameters[1];\u000a        self.access = parameters[2];\u000a\u000a        self._createToolEntry = function () {\u000a            var entry = {\u000a                name: ko.observable(),\u000a                key: ko.observable(),\u000a                actual: ko.observable(0),\u000a                target: ko.observable(0),\u000a                offset: ko.observable(0),\u000a                newTarget: ko.observable(),\u000a                newOffset: ko.observable()\u000a            };\u000a\u000a            entry.newTargetValid = ko.pureComputed(function () {\u000a                var value = entry.newTarget();\u000a\u000a                try {\u000a                    value = parseInt(value);\u000a                } catch (exc) {\u000a                    return false;\u000a                }\u000a\u000a                return value >= 0 && value <= 999;\u000a            });\u000a\u000a            entry.newOffsetValid = ko.pureComputed(function () {\u000a                var value = entry.newOffset();\u000a\u000a                try {\u000a                    value = parseInt(value);\u000a                } catch (exc) {\u000a                    return false;\u000a                }\u000a\u000a                return -50 <= value <= 50;\u000a            });\u000a\u000a            entry.offset.subscribe(function (newValue) {\u000a                if (\u000a                    self.changingOffset.item !== undefined &&\u000a                    self.changingOffset.item.key() === entry.key()\u000a                ) {\u000a                    // if our we currently have the offset dialog open for this entry and the offset changed\u000a                    // meanwhile, update the displayed value in the dialog\u000a                    self.changingOffset.offset(newValue);\u000a                }\u000a            });\u000a\u000a            return entry;\u000a        };\u000a\u000a        self.changingOffset = {\u000a            offset: ko.observable(0),\u000a            newOffset: ko.observable(0),\u000a            name: ko.observable(""),\u000a            item: undefined,\u000a\u000a            title: ko.pureComputed(function () {\u000a                return _.sprintf(gettext("Changing Offset of %(name)s"), {\u000a                    name: _.escape(self.changingOffset.name())\u000a                });\u000a            }),\u000a            description: ko.pureComputed(function () {\u000a                return _.sprintf(\u000a                    gettext(\u000a                        'Use the form below to specify a new offset to apply to all temperature commands sent from printed files for "%(name)s"'\u000a                    ),\u000a                    {name: _.escape(self.changingOffset.name())}\u000a                );\u000a            })\u000a        };\u000a        self.changeOffsetDialog = undefined;\u000a\u000a        // TODO: find some nicer way to update plot AFTER graph becomes visible\u000a        self.loginStateSubscription = undefined;\u000a\u000a        self.tools = ko.observableArray([]);\u000a        self.hasTools = ko.pureComputed(function () {\u000a            return self.tools().length > 0;\u000a        });\u000a        self.hasBed = ko.observable(true);\u000a        self.hasChamber = ko.observable(false);\u000a\u000a        self.visible = ko.pureComputed(function () {\u000a            return self.hasTools() || self.hasBed();\u000a        });\u000a\u000a        self.bedTemp = self._createToolEntry();\u000a        self.bedTemp["name"](gettext("Bed"));\u000a        self.bedTemp["key"]("bed");\u000a\u000a        self.chamberTemp = self._createToolEntry();\u000a        self.chamberTemp["name"](gettext("Chamber"));\u000a        self.chamberTemp["key"]("chamber");\u000a\u000a        self.isErrorOrClosed = ko.observable(undefined);\u000a        self.isOperational = ko.observable(undefined);\u000a        self.isPrinting = ko.observable(undefined);\u000a        self.isPaused = ko.observable(undefined);\u000a        self.isError = ko.observable(undefined);\u000a        self.isReady = ko.observable(undefined);\u000a        self.isLoading = ko.observable(undefined);\u000a\u000a        self.temperature_profiles = self.settingsViewModel.temperature_profiles;\u000a        self.temperature_cutoff = self.settingsViewModel.temperature_cutoff;\u000a\u000a        self.heaterOptions = ko.observable({});\u000a\u000a        self._printerProfileInitialized = false;\u000a        self._currentTemperatureDataBacklog = [];\u000a        self._historyTemperatureDataBacklog = [];\u000a\u000a        self._printerProfileUpdated = function () {\u000a            var graphColors = ["red", "orange", "green", "brown", "purple"];\u000a            var heaterOptions = {};\u000a            var tools = [];\u000a            var color;\u000a\u000a            // tools\u000a            var currentProfileData = self.settingsViewModel.printerProfiles.currentProfileData();\u000a            var numExtruders = currentProfileData\u000a                ? currentProfileData.extruder.count()\u000a                : 0;\u000a            var sharedNozzle = currentProfileData\u000a                ? currentProfileData.extruder.sharedNozzle()\u000a                : false;\u000a            if (numExtruders && numExtruders > 1 && !sharedNozzle) {\u000a                // multiple extruders\u000a                for (var extruder = 0; extruder < numExtruders; extruder++) {\u000a                    color = graphColors.shift();\u000a                    if (!color) color = "black";\u000a                    heaterOptions["tool" + extruder] = {\u000a                        name: "T" + extruder,\u000a                        color: color\u000a                    };\u000a\u000a                    if (tools.length <= extruder || !tools[extruder]) {\u000a                        tools[extruder] = self._createToolEntry();\u000a                    }\u000a                    tools[extruder]["name"](gettext("Tool") + " " + extruder);\u000a                    tools[extruder]["key"]("tool" + extruder);\u000a                }\u000a            } else if (numExtruders === 1 || sharedNozzle) {\u000a                // only one extruder, no need to add numbers\u000a                color = graphColors[0];\u000a                heaterOptions["tool0"] = {name: "T", color: color};\u000a\u000a                if (tools.length < 1 || !tools[0]) {\u000a                    tools[0] = self._createToolEntry();\u000a                }\u000a                tools[0]["name"](gettext("Tool"));\u000a                tools[0]["key"]("tool0");\u000a            }\u000a\u000a            // print bed\u000a            if (currentProfileData && currentProfileData.heatedBed()) {\u000a                self.hasBed(true);\u000a                heaterOptions["bed"] = {name: gettext("Bed"), color: "blue"};\u000a            } else {\u000a                self.hasBed(false);\u000a            }\u000a\u000a            // heated chamber\u000a            if (currentProfileData && currentProfileData.heatedChamber()) {\u000a                self.hasChamber(true);\u000a                heaterOptions["chamber"] = {name: gettext("Chamber"), color: "black"};\u000a            } else {\u000a                self.hasChamber(false);\u000a            }\u000a\u000a            // write back\u000a            self.heaterOptions(heaterOptions);\u000a            self.tools(tools);\u000a\u000a            if (!self._printerProfileInitialized) {\u000a                self._triggerBacklog();\u000a            }\u000a            self.updatePlot();\u000a        };\u000a\u000a        self.settingsViewModel.printerProfiles.currentProfileData.subscribe(function () {\u000a            self._printerProfileUpdated();\u000a            self.settingsViewModel.printerProfiles\u000a                .currentProfileData()\u000a                .extruder.count.subscribe(self._printerProfileUpdated);\u000a            self.settingsViewModel.printerProfiles\u000a                .currentProfileData()\u000a                .extruder.sharedNozzle.subscribe(self._printerProfileUpdated);\u000a            self.settingsViewModel.printerProfiles\u000a                .currentProfileData()\u000a                .heatedBed.subscribe(self._printerProfileUpdated);\u000a            self.settingsViewModel.printerProfiles\u000a                .currentProfileData()\u000a                .heatedChamber.subscribe(self._printerProfileUpdated);\u000a        });\u000a\u000a        self.temperatures = [];\u000a\u000a        self.plot = undefined;\u000a        self.plotHoverPos = undefined;\u000a        self.plotLegendTimeout = undefined;\u000a\u000a        self.fromCurrentData = function (data) {\u000a            self._processStateData(data.state);\u000a            if (!self._printerProfileInitialized) {\u000a                self._currentTemperatureDataBacklog.push(data);\u000a            } else {\u000a                self._processTemperatureUpdateData(data.serverTime, data.temps);\u000a            }\u000a            self._processOffsetData(data.offsets);\u000a        };\u000a\u000a        self.fromHistoryData = function (data) {\u000a            self._processStateData(data.state);\u000a            if (!self._printerProfileInitialized) {\u000a                self._historyTemperatureDataBacklog.push(data);\u000a            } else {\u000a                self._processTemperatureHistoryData(data.serverTime, data.temps);\u000a            }\u000a            self._processOffsetData(data.offsets);\u000a        };\u000a\u000a        self._triggerBacklog = function () {\u000a            _.each(self._historyTemperatureDataBacklog, function (data) {\u000a                self._processTemperatureHistoryData(data.serverTime, data.temps);\u000a            });\u000a            _.each(self._currentTemperatureDataBacklog, function (data) {\u000a                self._processTemperatureUpdateData(data.serverTime, data.temps);\u000a            });\u000a            self._historyTemperatureDataBacklog = [];\u000a            self._currentTemperatureDataBacklog = [];\u000a            self._printerProfileInitialized = true;\u000a        };\u000a\u000a        self._processStateData = function (data) {\u000a            self.isErrorOrClosed(data.flags.closedOrError);\u000a            self.isOperational(data.flags.operational);\u000a            self.isPaused(data.flags.paused);\u000a            self.isPrinting(data.flags.printing);\u000a            self.isError(data.flags.error);\u000a            self.isReady(data.flags.ready);\u000a            self.isLoading(data.flags.loading);\u000a        };\u000a\u000a        self._processTemperatureUpdateData = function (serverTime, data) {\u000a            if (data.length === 0) return;\u000a\u000a            var lastData = data[data.length - 1];\u000a\u000a            var tools = self.tools();\u000a            for (var i = 0; i < tools.length; i++) {\u000a                if (lastData.hasOwnProperty("tool" + i)) {\u000a                    tools[i]["actual"](lastData["tool" + i].actual);\u000a                    tools[i]["target"](lastData["tool" + i].target);\u000a                } else {\u000a                    tools[i]["actual"](0);\u000a                    tools[i]["target"](0);\u000a                }\u000a            }\u000a\u000a            if (lastData.hasOwnProperty("bed")) {\u000a                self.bedTemp["actual"](lastData.bed.actual);\u000a                self.bedTemp["target"](lastData.bed.target);\u000a            } else {\u000a                self.bedTemp["actual"](0);\u000a                self.bedTemp["target"](0);\u000a            }\u000a\u000a            if (lastData.hasOwnProperty("chamber")) {\u000a                self.chamberTemp["actual"](lastData.chamber.actual);\u000a                self.chamberTemp["target"](lastData.chamber.target);\u000a            } else {\u000a                self.chamberTemp["actual"](0);\u000a                self.chamberTemp["target"](0);\u000a            }\u000a\u000a            if (!CONFIG_TEMPERATURE_GRAPH) return;\u000a\u000a            self.temperatures = self._processTemperatureData(\u000a                serverTime,\u000a                data,\u000a                self.temperatures\u000a            );\u000a            self.updatePlot();\u000a        };\u000a\u000a        self._processTemperatureHistoryData = function (serverTime, data) {\u000a            self.temperatures = self._processTemperatureData(serverTime, data);\u000a            self.updatePlot();\u000a        };\u000a\u000a        self._processOffsetData = function (data) {\u000a            var tools = self.tools();\u000a            for (var i = 0; i < tools.length; i++) {\u000a                if (data.hasOwnProperty("tool" + i)) {\u000a                    tools[i]["offset"](data["tool" + i]);\u000a                } else {\u000a                    tools[i]["offset"](0);\u000a                }\u000a            }\u000a\u000a            if (data.hasOwnProperty("bed")) {\u000a                self.bedTemp["offset"](data["bed"]);\u000a            } else {\u000a                self.bedTemp["offset"](0);\u000a            }\u000a\u000a            if (data.hasOwnProperty("chamber")) {\u000a                self.chamberTemp["offset"](data["chamber"]);\u000a            } else {\u000a                self.chamberTemp["offset"](0);\u000a            }\u000a        };\u000a\u000a        self._processTemperatureData = function (serverTime, data, result) {\u000a            var types = _.keys(self.heaterOptions());\u000a            var clientTime = Date.now();\u000a\u000a            // make sure result is properly initialized\u000a            if (!result) {\u000a                result = {};\u000a            }\u000a\u000a            _.each(types, function (type) {\u000a                if (!result.hasOwnProperty(type)) {\u000a                    result[type] = {actual: [], target: []};\u000a                }\u000a                if (!result[type].hasOwnProperty("actual")) result[type]["actual"] = [];\u000a                if (!result[type].hasOwnProperty("target")) result[type]["target"] = [];\u000a            });\u000a\u000a            // convert data\u000a            _.each(data, function (d) {\u000a                var timeDiff = (serverTime - d.time) * 1000;\u000a                var time = clientTime - timeDiff;\u000a                _.each(types, function (type) {\u000a                    if (!d[type]) return;\u000a                    result[type].actual.push([time, d[type].actual]);\u000a                    result[type].target.push([time, d[type].target]);\u000a                });\u000a            });\u000a\u000a            var temperature_cutoff = self.temperature_cutoff();\u000a            if (temperature_cutoff !== undefined) {\u000a                var filterOld = function (item) {\u000a                    return item[0] >= clientTime - temperature_cutoff * 60 * 1000;\u000a                };\u000a\u000a                _.each(_.keys(self.heaterOptions()), function (d) {\u000a                    result[d].actual = _.filter(result[d].actual, filterOld);\u000a                    result[d].target = _.filter(result[d].target, filterOld);\u000a                });\u000a            }\u000a\u000a            return result;\u000a        };\u000a\u000a        self.profileText = function (heater, profile) {\u000a            var text = gettext("Set %(name)s (%(value)s)");\u000a\u000a            var format = function (temp) {\u000a                if (temp === 0 || temp === undefined || temp === null) {\u000a                    return gettext("Off");\u000a                } else {\u000a                    return "" + temp + "°C";\u000a                }\u000a            };\u000a\u000a            var value;\u000a            if (heater === "all") {\u000a                value = gettext("Tool") + ": %(extruder)s";\u000a                if (self.hasBed()) {\u000a                    value += "/" + gettext("Bed") + ": %(bed)s";\u000a                }\u000a                if (self.hasChamber()) {\u000a                    value += "/" + gettext("Chamber") + ": %(chamber)s";\u000a                }\u000a                value = _.sprintf(value, {\u000a                    extruder: format(profile.extruder),\u000a                    bed: format(profile.bed),\u000a                    chamber: format(profile.chamber)\u000a                });\u000a            } else if (heater.key() === "bed") {\u000a                value = format(profile.bed);\u000a            } else if (heater.key() === "chamber") {\u000a                value = format(profile.chamber);\u000a            } else {\u000a                value = format(profile.extruder);\u000a            }\u000a\u000a            return _.sprintf(text, {\u000a                name: _.escape(profile.name),\u000a                value: _.escape(value)\u000a            });\u000a        };\u000a\u000a        self.updatePlot = function () {\u000a            var graph = $("#temperature-graph");\u000a            if (!graph.length) return; // no graph\u000a            if (!self.plot) return; // plot not yet initialized\u000a\u000a            var plotInfo = self._getPlotInfo();\u000a            if (plotInfo === undefined) return;\u000a\u000a            var newMax = Math.max(Math.max.apply(null, plotInfo.max) * 1.1, 310);\u000a            if (newMax !== self.plot.getAxes().yaxis.max) {\u000a                // re-init (because flot apparently has NO way to change the max value of an axes :/)\u000a                self._initializePlot(true, plotInfo);\u000a            } else {\u000a                // update the data\u000a                self.plot.setData(plotInfo.data);\u000a                self.plot.setupGrid();\u000a                self.updateLegend(self._replaceLegendLabel);\u000a                self.plot.draw();\u000a            }\u000a        };\u000a\u000a        self._initializePlot = function (force, plotInfo) {\u000a            var graph = $("#temperature-graph");\u000a            if (!graph.length) return; // no graph\u000a            if (self.plot && !force) return; // already initialized\u000a\u000a            plotInfo = plotInfo || self._getPlotInfo();\u000a            if (plotInfo === undefined) return;\u000a\u000a            // we don't have a plot yet, we need to set stuff up\u000a            var options = {\u000a                yaxis: {\u000a                    min: 0,\u000a                    max: Math.max(Math.max.apply(null, plotInfo.max) * 1.1, 310),\u000a                    ticks: 10,\u000a                    tickFormatter: function (val, axis) {\u000a                        if (val === undefined || val === 0) return "";\u000a                        return val + "°C";\u000a                    }\u000a                },\u000a                xaxis: {\u000a                    mode: "time",\u000a                    minTickSize: [2, "minute"],\u000a                    tickFormatter: function (val, axis) {\u000a                        if (val === undefined || val === 0) return ""; // we don't want to display the minutes since the epoch if not connected yet ;)\u000a\u000a                        // current time in milliseconds in UTC\u000a                        var timestampUtc = Date.now();\u000a\u000a                        // calculate difference in milliseconds\u000a                        var diff = timestampUtc - val;\u000a\u000a                        // convert to minutes\u000a                        var diffInMins = Math.round(diff / (60 * 1000));\u000a                        if (diffInMins === 0) {\u000a                            // don't write anything for "just now"\u000a                            return "";\u000a                        } else if (diffInMins < 0) {\u000a                            // we can't look into the future\u000a                            return "";\u000a                        } else {\u000a                            return "- " + diffInMins + " " + gettext("min");\u000a                        }\u000a                    }\u000a                },\u000a                legend: {\u000a                    position: "sw",\u000a                    noColumns: 2,\u000a                    backgroundOpacity: 0\u000a                }\u000a            };\u000a\u000a            if (!OctoPrint.coreui.browser.mobile) {\u000a                options["crosshair"] = {mode: "x"};\u000a                options["grid"] = {hoverable: true, autoHighlight: false};\u000a            }\u000a\u000a            self.plot = $.plot(graph, plotInfo.data, options);\u000a        };\u000a\u000a        self._getPlotInfo = function () {\u000a            var data = [];\u000a            var heaterOptions = self.heaterOptions();\u000a            if (!heaterOptions) return undefined;\u000a\u000a            var maxTemps = [310 / 1.1];\u000a            var now = Date.now();\u000a\u000a            var showFahrenheit = self._shallShowFahrenheit();\u000a\u000a            _.each(_.keys(heaterOptions), function (type) {\u000a                if (type === "bed" && !self.hasBed()) {\u000a                    return;\u000a                }\u000a\u000a                var actuals = [];\u000a                var targets = [];\u000a\u000a                if (self.temperatures[type]) {\u000a                    actuals = self.temperatures[type].actual;\u000a                    targets = self.temperatures[type].target;\u000a                }\u000a\u000a                var actualTemp =\u000a                    actuals && actuals.length\u000a                        ? formatTemperature(\u000a                              actuals[actuals.length - 1][1],\u000a                              showFahrenheit\u000a                          )\u000a                        : "-";\u000a                var targetTemp =\u000a                    targets && targets.length\u000a                        ? formatTemperature(\u000a                              targets[targets.length - 1][1],\u000a                              showFahrenheit,\u000a                              1\u000a                          )\u000a                        : "-";\u000a\u000a                data.push({\u000a                    label:\u000a                        gettext("Actual") +\u000a                        " " +\u000a                        heaterOptions[type].name +\u000a                        ": " +\u000a                        actualTemp,\u000a                    color: heaterOptions[type].color,\u000a                    data: actuals.length ? actuals : [[now, undefined]]\u000a                });\u000a                data.push({\u000a                    label:\u000a                        gettext("Target") +\u000a                        " " +\u000a                        heaterOptions[type].name +\u000a                        ": " +\u000a                        targetTemp,\u000a                    color: pusher.color(heaterOptions[type].color).tint(0.5).html(),\u000a                    data: targets.length ? targets : [[now, undefined]]\u000a                });\u000a\u000a                maxTemps.push(self.getMaxTemp(actuals, targets));\u000a            });\u000a\u000a            return {max: maxTemps, data: data};\u000a        };\u000a\u000a        self.updateLegend = function (replaceLegendLabel) {\u000a            self.plotLegendTimeout = undefined;\u000a\u000a            var resetLegend = function () {\u000a                _.each(dataset, function (series, index) {\u000a                    var value =\u000a                        series.data && series.data.length\u000a                            ? series.data[series.data.length - 1][1]\u000a                            : undefined;\u000a                    replaceLegendLabel(index, series, value);\u000a                });\u000a            };\u000a\u000a            var pos = self.plotHoverPos;\u000a            if (pos && !OctoPrint.coreui.browser.mobile) {\u000a                // we got a hover position, let's see what we need to do with that\u000a\u000a                var i;\u000a                var axes = self.plot.getAxes();\u000a                var dataset = self.plot.getData();\u000a\u000a                if (\u000a                    pos.x < axes.xaxis.min ||\u000a                    pos.x > axes.xaxis.max ||\u000a                    pos.y < axes.yaxis.min ||\u000a                    pos.y > axes.yaxis.max\u000a                ) {\u000a                    // position outside of the graph, show latest temperature in legend\u000a                    resetLegend();\u000a                } else {\u000a                    // position inside the graph, determine temperature at point and display that in the legend\u000a                    _.each(dataset, function (series, index) {\u000a                        for (i = 0; i < series.data.length; i++) {\u000a                            if (series.data[i][0] > pos.x) {\u000a                                break;\u000a                            }\u000a                        }\u000a\u000a                        var y;\u000a                        var p1 = series.data[i - 1];\u000a                        var p2 = series.data[i];\u000a\u000a                        if (p1 === undefined && p2 === undefined) {\u000a                            y = undefined;\u000a                        } else if (p1 === undefined) {\u000a                            y = p2[1];\u000a                        } else if (p2 === undefined) {\u000a                            y = p1[1];\u000a                        } else {\u000a                            y =\u000a                                p1[1] +\u000a                                ((p2[1] - p1[1]) * (pos.x - p1[0])) / (p2[0] - p1[0]);\u000a                        }\u000a\u000a                        replaceLegendLabel(index, series, y, true);\u000a                    });\u000a                }\u000a            } else {\u000a                resetLegend();\u000a            }\u000a\u000a            // update the grid\u000a            self.plot.setupGrid();\u000a        };\u000a\u000a        self.getMaxTemp = function (actuals, targets) {\u000a            var maxTemp = 0;\u000a            actuals.forEach(function (pair) {\u000a                if (pair[1] > maxTemp) {\u000a                    maxTemp = pair[1];\u000a                }\u000a            });\u000a            targets.forEach(function (pair) {\u000a                if (pair[1] > maxTemp) {\u000a                    maxTemp = pair[1];\u000a                }\u000a            });\u000a            return maxTemp;\u000a        };\u000a\u000a        self.incrementTarget = function (item) {\u000a            var value = item.newTarget();\u000a            if (\u000a                value === undefined ||\u000a                (typeof value === "string" && value.trim() === "")\u000a            ) {\u000a                value = item.target();\u000a            }\u000a            try {\u000a                value = parseInt(value);\u000a                if (value > 999) return;\u000a                item.newTarget(value + 1);\u000a                self.autosendTarget(item);\u000a            } catch (ex) {\u000a                // do nothing\u000a            }\u000a        };\u000a\u000a        self.decrementTarget = function (item) {\u000a            var value = item.newTarget();\u000a            if (\u000a                value === undefined ||\u000a                (typeof value === "string" && value.trim() === "")\u000a            ) {\u000a                value = item.target();\u000a            }\u000a            try {\u000a                value = parseInt(value);\u000a                if (value <= 0) return;\u000a                item.newTarget(value - 1);\u000a                self.autosendTarget(item);\u000a            } catch (ex) {\u000a                // do nothing\u000a            }\u000a        };\u000a\u000a        var _sendTimeout = {};\u000a\u000a        self.autosendTarget = function (item) {\u000a            if (!self.settingsViewModel.temperature_sendAutomatically()) return;\u000a            var delay =\u000a                self.settingsViewModel.temperature_sendAutomaticallyAfter() * 1000;\u000a\u000a            var name = item.name();\u000a            if (_sendTimeout[name]) {\u000a                window.clearTimeout(_sendTimeout[name]);\u000a            }\u000a            _sendTimeout[name] = window.setTimeout(function () {\u000a                self.setTarget(item);\u000a                delete _sendTimeout[name];\u000a            }, delay);\u000a        };\u000a\u000a        self.clearAutosendTarget = function (item) {\u000a            var name = item.name();\u000a            if (_sendTimeout[name]) {\u000a                window.clearTimeout(_sendTimeout[name]);\u000a                delete _sendTimeout[name];\u000a            }\u000a        };\u000a\u000a        self.setTarget = function (item, form) {\u000a            var value = item.newTarget();\u000a            if (form !== undefined) {\u000a                $(form).find("input").blur();\u000a            }\u000a            if (value === undefined || (typeof value === "string" && value.trim() === ""))\u000a                return OctoPrintClient.createRejectedDeferred();\u000a\u000a            self.clearAutosendTarget(item);\u000a            return self.setTargetToValue(item, value);\u000a        };\u000a\u000a        // Wrapper of self.setTargetFromProfile() to apply all the temperature from a temperature profile\u000a        self.setTargetsFromProfile = function (temperatureProfile) {\u000a            if (temperatureProfile === undefined) {\u000a                console.log("temperatureProfile is undefined!");\u000a                return;\u000a            }\u000a\u000a            if (self.hasBed()) {\u000a                self.setTargetFromProfile(self.bedTemp, temperatureProfile);\u000a            }\u000a\u000a            if (self.hasChamber()) {\u000a                self.setTargetFromProfile(self.chamberTemp, temperatureProfile);\u000a            }\u000a\u000a            self.tools().forEach(function (element) {\u000a                self.setTargetFromProfile(element, temperatureProfile);\u000a            });\u000a        };\u000a\u000a        self.setTargetFromProfile = function (item, profile) {\u000a            if (!profile) return OctoPrintClient.createRejectedDeferred();\u000a\u000a            self.clearAutosendTarget(item);\u000a\u000a            var target;\u000a            if (item.key() === "bed") {\u000a                target = profile.bed;\u000a            } else if (item.key() === "chamber") {\u000a                target = profile.chamber;\u000a            } else {\u000a                target = profile.extruder;\u000a            }\u000a\u000a            if (target === undefined) target = 0;\u000a            return self.setTargetToValue(item, target);\u000a        };\u000a\u000a        // Wrapper of self.setTargetToZero() to set off all the temperatures\u000a        self.setTargetsToZero = function () {\u000a            if (self.hasBed()) {\u000a                self.setTargetToZero(self.bedTemp);\u000a            }\u000a\u000a            if (self.hasChamber()) {\u000a                self.setTargetToZero(self.chamberTemp);\u000a            }\u000a\u000a            self.tools().forEach(function (element) {\u000a                self.setTargetToZero(element);\u000a            });\u000a        };\u000a\u000a        self.setTargetToZero = function (item) {\u000a            self.clearAutosendTarget(item);\u000a            return self.setTargetToValue(item, 0);\u000a        };\u000a\u000a        self.setTargetToValue = function (item, value) {\u000a            self.clearAutosendTarget(item);\u000a\u000a            try {\u000a                value = parseInt(value);\u000a            } catch (ex) {\u000a                return OctoPrintClient.createRejectedDeferred();\u000a            }\u000a\u000a            if (value < 0 || value > 999) return OctoPrintClient.createRejectedDeferred();\u000a\u000a            var onSuccess = function () {\u000a                item.target(value);\u000a                item.newTarget("");\u000a            };\u000a\u000a            if (item.key() === "bed") {\u000a                return self._setBedTemperature(value).done(onSuccess);\u000a            } else if (item.key() === "chamber") {\u000a                return self._setChamberTemperature(value).done(onSuccess);\u000a            } else {\u000a                return self._setToolTemperature(item.key(), value).done(onSuccess);\u000a            }\u000a        };\u000a\u000a        self.changeOffset = function (item) {\u000a            // copy values\u000a            self.changingOffset.item = item;\u000a            self.changingOffset.name(item.name());\u000a            self.changingOffset.offset(item.offset());\u000a            self.changingOffset.newOffset(item.offset());\u000a\u000a            self.changeOffsetDialog.modal("show");\u000a        };\u000a\u000a        self.incrementChangeOffset = function () {\u000a            var value = self.changingOffset.newOffset();\u000a            if (value === undefined || (typeof value === "string" && value.trim() === ""))\u000a                value = self.changingOffset.offset();\u000a            try {\u000a                value = parseInt(value);\u000a                if (value >= 50) return;\u000a                self.changingOffset.newOffset(value + 1);\u000a            } catch (ex) {\u000a                // do nothing\u000a            }\u000a        };\u000a\u000a        self.decrementChangeOffset = function () {\u000a            var value = self.changingOffset.newOffset();\u000a            if (value === undefined || (typeof value === "string" && value.trim() === ""))\u000a                value = self.changingOffset.offset();\u000a            try {\u000a                value = parseInt(value);\u000a                if (value <= -50) return;\u000a                self.changingOffset.newOffset(value - 1);\u000a            } catch (ex) {\u000a                // do nothing\u000a            }\u000a        };\u000a\u000a        self.deleteChangeOffset = function () {\u000a            self.changingOffset.newOffset(0);\u000a        };\u000a\u000a        self.confirmChangeOffset = function () {\u000a            var item = self.changingOffset.item;\u000a            item.newOffset(self.changingOffset.newOffset());\u000a\u000a            self.setOffset(item).done(function () {\u000a                self.changeOffsetDialog.modal("hide");\u000a\u000a                // reset\u000a                self.changingOffset.offset(0);\u000a                self.changingOffset.newOffset(0);\u000a                self.changingOffset.name("");\u000a                self.changingOffset.item = undefined;\u000a            });\u000a        };\u000a\u000a        self.setOffset = function (item) {\u000a            var value = item.newOffset();\u000a            if (value === undefined || (typeof value === "string" && value.trim() === ""))\u000a                return OctoPrintClient.createRejectedDeferred();\u000a            return self.setOffsetToValue(item, value);\u000a        };\u000a\u000a        self.setOffsetToZero = function (item) {\u000a            return self.setOffsetToValue(item, 0);\u000a        };\u000a\u000a        self.setOffsetToValue = function (item, value) {\u000a            try {\u000a                value = parseInt(value);\u000a            } catch (ex) {\u000a                return OctoPrintClient.createRejectedDeferred();\u000a            }\u000a\u000a            if (value < -50 || value > 50)\u000a                return OctoPrintClient.createRejectedDeferred();\u000a\u000a            var onSuccess = function () {\u000a                item.offset(value);\u000a                item.newOffset("");\u000a            };\u000a\u000a            if (item.key() === "bed") {\u000a                return self._setBedOffset(value).done(onSuccess);\u000a            } else if (item.key() === "chamber") {\u000a                return self._setChamberOffset(value).done(onSuccess);\u000a            } else {\u000a                return self._setToolOffset(item.key(), value).done(onSuccess);\u000a            }\u000a        };\u000a\u000a        self._setToolTemperature = function (tool, temperature) {\u000a            var data = {};\u000a            data[tool] = parseInt(temperature);\u000a            return OctoPrint.printer.setToolTargetTemperatures(data);\u000a        };\u000a\u000a        self._setToolOffset = function (tool, offset) {\u000a            var data = {};\u000a            data[tool] = parseInt(offset);\u000a            return OctoPrint.printer.setToolTemperatureOffsets(data);\u000a        };\u000a\u000a        self._setBedTemperature = function (temperature) {\u000a            return OctoPrint.printer.setBedTargetTemperature(parseInt(temperature));\u000a        };\u000a\u000a        self._setBedOffset = function (offset) {\u000a            return OctoPrint.printer.setBedTemperatureOffset(parseInt(offset));\u000a        };\u000a\u000a        self._setChamberTemperature = function (temperature) {\u000a            return OctoPrint.printer.setChamberTargetTemperature(parseInt(temperature));\u000a        };\u000a\u000a        self._setChamberOffset = function (offset) {\u000a            return OctoPrint.printer.setChamberTemperatureOffset(parseInt(offset));\u000a        };\u000a\u000a        self._replaceLegendLabel = function (index, series, value, emph) {\u000a            var showFahrenheit = self._shallShowFahrenheit();\u000a\u000a            var temp;\u000a            if (index % 2 === 0) {\u000a                // actual series\u000a                temp = formatTemperature(value, showFahrenheit);\u000a            } else {\u000a                // target series\u000a                temp = formatTemperature(value, showFahrenheit, 1);\u000a            }\u000a            if (emph) {\u000a                temp = "<em>" + temp + "</em>";\u000a            }\u000a            series.label = series.label.replace(/:.*/, ": " + temp);\u000a        };\u000a\u000a        self._shallShowFahrenheit = function () {\u000a            return self.settingsViewModel.settings !== undefined\u000a                ? self.settingsViewModel.settings.appearance.showFahrenheitAlso()\u000a                : false;\u000a        };\u000a\u000a        self.handleEnter = function (event, type, item) {\u000a            if (event.keyCode === 13) {\u000a                if (type === "target") {\u000a                    self.setTarget(item).done(function () {\u000a                        event.target.blur();\u000a                    });\u000a                } else if (type === "offset") {\u000a                    self.confirmChangeOffset();\u000a                }\u000a            }\u000a        };\u000a\u000a        self.handleFocus = function (event, type, item) {\u000a            if (type === "target") {\u000a                var value = item.newTarget();\u000a                if (\u000a                    value === undefined ||\u000a                    (typeof value === "string" && value.trim() === "")\u000a                ) {\u000a                    item.newTarget(item.target());\u000a                }\u000a                window.setTimeout(function () {\u000a                    event.target.select();\u000a                }, 0);\u000a            } else if (type === "offset") {\u000a                window.setTimeout(function () {\u000a                    event.target.select();\u000a                }, 0);\u000a            }\u000a        };\u000a\u000a        self.initOrUpdate = function () {\u000a            if (OctoPrint.coreui.selectedTab !== "#temp" || !$("#temp").is(":visible")) {\u000a                // do not try to initialize the graph when it's not visible or its sizing will be off\u000a                return;\u000a            }\u000a\u000a            if (!self.plot) {\u000a                self._initializePlot();\u000a            } else {\u000a                self.updatePlot();\u000a            }\u000a        };\u000a\u000a        self.onAfterTabChange = function () {\u000a            self.initOrUpdate();\u000a        };\u000a\u000a        self.onStartup = function () {\u000a            var graph = $("#temperature-graph");\u000a            if (graph.length && !OctoPrint.coreui.browser.mobile) {\u000a                graph.bind("plothover", function (event, pos, item) {\u000a                    self.plotHoverPos = pos;\u000a                    if (!self.plotLegendTimeout) {\u000a                        self.plotLegendTimeout = window.setTimeout(function () {\u000a                            self.updateLegend(self._replaceLegendLabel);\u000a                        }, 50);\u000a                    }\u000a                });\u000a            }\u000a\u000a            self.changeOffsetDialog = $("#change_offset_dialog");\u000a        };\u000a\u000a        self.onStartupComplete = function () {\u000a            self.initOrUpdate();\u000a            self._printerProfileUpdated();\u000a        };\u000a\u000a        self.onUserPermissionsChanged = self.onUserLoggedIn = self.onUserLoggedOut = function () {\u000a            self.initOrUpdate();\u000a        };\u000a    }\u000a\u000a    OCTOPRINT_VIEWMODELS.push({\u000a        construct: TemperatureViewModel,\u000a        dependencies: ["loginStateViewModel", "settingsViewModel", "accessViewModel"],\u000a        elements: ["#temp", "#temp_link", "#change_offset_dialog"]\u000a    });\u000a});\u000a\u000a;\u000a
p0
.