V// source: plugin/uicustomizer/js/uicustomizer.js\u000a/* UICustomizer START */\u000a$(function() {\u000a    function UICustomizerViewModel(parameters) {\u000a        var self = this;\u000a        // Run in debug/verbose mode\u000a        self.debug = false;\u000a\u000a        // Set settings\u000a        self.settings = parameters[0];\u000a        // max column width\u000a        self.maxCWidth = 12;\u000a\u000a        self.saved = false;\u000a\u000a        // Setting preview\u000a        self.previewOn = false;\u000a        self.previewHasBeenOn = false;\u000a        self.settingsBeenShown = false;\u000a\u000a        self.getReturnData = false;\u000a\u000a        // timer for resize fix modal\u000a        self.modalTimer = null;\u000a\u000a        self.nameLookup = {\u000a            'div.UICmainTabs' : '<i class="fas fa-columns"></i> Main tabs',\u000a            '#UICWebCamWidget' : '<i class="fas fa-camera"></i> Webcam',\u000a            '#UICGcodeVWidget' : '<i class="fab icon-black fa-codepen"></i> Gcode'\u000a        }\u000a\u000a        self.customWidgets = {\u000a            '#UICWebCamWidget' : {\u000a                'dom': '<div id="UICWebCamWidget" class="accordion-group " data-bind="visible: loginState.hasAnyPermissionKo(access.permissions.WEBCAM)">\u005c\u000a                            <div class="accordion-heading">\u005c\u000a                                <a class="accordion-toggle" data-toggle="collapse" data-target="#IUCWebcamContainer">\u005c\u000a                                    <i class="fas icon-black fa-camera"></i> Webcam\u005c\u000a                                </a>\u005c\u000a                            </div>\u005c\u000a                            <div id="IUCWebcamContainer" class="accordion-body in collapse">\u005c\u000a                                <div class="accordion-inner">\u005c\u000a                                </div>\u005c\u000a                            </div>\u005c\u000a                        </div>',\u000a                'init' : 'CustomW_initWebCam',\u000a            },\u000a            '#UICGcodeVWidget' : {\u000a                'dom': '<div id="UICGcodeVWidget" class="accordion-group " data-bind="allowBindings: true, visible: loginState.hasAllPermissionsKo(access.permissions.GCODE_VIEWER, access.permissions.FILES_DOWNLOAD)">\u005c\u000a                            <div class="accordion-heading">\u005c\u000a                                <a class="accordion-toggle" data-toggle="collapse" data-target="#UICGcodeVWidgetContainer">\u005c\u000a                                    <i class="fab icon-black fa-codepen"></i> Gcode\u005c\u000a                                </a>\u005c\u000a                                <div class="btn-group UICWidgetSelector"><a class="btn btn-small dropdown-toggle" data-toggle="dropdown" href="#">Zoom:<span id="UICGcodeVWidgetZL"></span><span class="caret"></span></a><ul class="dropdown-menu"><li><a href="javascript:void(0);" data-zoomlvl=4>4</a></li><li><a href="javascript:void(0);" data-zoomlvl=3>3</a></li><li><a href="javascript:void(0);" data-zoomlvl=2>2</a></li><li><a href="javascript:void(0);" data-zoomlvl=1.5>1.5</a></li><li><a href="javascript:void(0);" data-zoomlvl=1>1</a></li></ul></div>\u005c\u000a                            </div>\u005c\u000a                            <div id="UICGcodeVWidgetContainer" class="accordion-body in collapse">\u005c\u000a                                <div class="accordion-inner">\u005c\u000a                                    <canvas id="UICGcodeVWidgetCan"/>\u005c\u000a                                </div>\u005c\u000a                            </div>\u005c\u000a                        </div>',\u000a                'init' : 'CustomW_initGcode',\u000a            }\u000a        }\u000a\u000a        // Store webcam init\u000a        self.onWebCamOrg = null;\u000a        self.onWebCamErrorOrg = null;\u000a\u000a        // Store sort\u000a        self.SortableSet = [];\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Quick debug\u000a        self.logToConsole = function(msg){\u000a            if (!self.debug){\u000a                return true;\u000a            }\u000a            if (typeof console.log == "function"){\u000a                console.log('UICustomizer:',msg)\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Initial bound and init the custom layout\u000a        self.onAllBound = function(){\u000a            // Store WebCam\u000a            self.onWebCamOrg = OctoPrint.coreui.viewmodels.controlViewModel.onWebcamLoaded;\u000a            self.onWebCamErrorOrg = OctoPrint.coreui.viewmodels.controlViewModel.onWebcamErrored;\u000a\u000a            // Set names\u000a            $('div.octoprint-container div.tabbable').addClass('UICmainTabs').wrap( '<div class="UICCol2"></div>');\u000a            $('#sidebar').addClass('UICCol1');\u000a            $('div.octoprint-container').addClass('UICMainCont');\u000a            $('#navbar div.navbar-inner > div > div.nav-collapse').addClass('UICMainMenu');\u000a            $('#navbar_plugin_announcements').addClass('UICExcludeFromTopIcons');\u000a\u000a            // Disable output off the terminal if inactive\u000a            var oldfunction = OctoPrint.coreui.viewmodels.terminalViewModel._processCurrentLogData;\u000a            OctoPrint.coreui.viewmodels.terminalViewModel._processCurrentLogData = function(data) {\u000a                if (OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.uicustomizer.disableTermInactive() && (!OctoPrint.coreui.viewmodels.terminalViewModel.tabActive || !OctoPrint.coreui.browserTabVisible)){\u000a                    return;\u000a                }\u000a                oldfunction(data);\u000a            };\u000a\u000a            // Fix SD card upload\u000a            $('#gcode_upload_sd').parent().find('i.fas.fa-upload').removeClass('fa-upload').addClass('fa-sd-card');\u000a\u000a            // Load custom layout\u000a            self.UpdateLayout(self.settings.settings.plugins.uicustomizer);\u000a\u000a            // Fix consolidate_temp_control layout issues\u000a            if (typeof OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.consolidate_temp_control !== "undefined"){\u000a                $('div.page-container').css({'min-width':''});\u000a                $('div.footer').css({'padding-left':'','padding-right':''});\u000a                $('div.UICMainCont > div:first').css({'margin-left':'','padding-right':''});\u000a                $('div.UICMainCont').removeClass('row-fluid');\u000a                $('div.UICmainTabs').removeClass('span10');\u000a                $('div#tabs_content div.tab-pane:not("#tab_plugin_consolidate_temp_control") > div > div.span6').unwrap();\u000a                $('div#tabs_content div.tab-pane:not("#tab_plugin_consolidate_temp_control") > div.span6').children().unwrap();\u000a            }\u000a\u000a            // Observe theme changes\u000a            OctoPrint.coreui.viewmodels.settingsViewModel.appearance_color.subscribe(function(color) {\u000a                self.updateStandardTheme(color);\u000a            });\u000a            if (OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.hasOwnProperty('themeify')){\u000a                OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.themeify.theme.subscribe(function(theme) {\u000a                    self.updateThemify(theme);\u000a                });\u000a                OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.themeify.enabled.subscribe(function(enabled) {\u000a                    self.updateThemify(OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.themeify.theme());\u000a                });\u000a            }\u000a\u000a            // Check these plugins\u000a            var knowPluginIssues = {\u000a                'widescreen' : {\u000a                    'text': 'The plugin OctoPrint-WideScreen collides with the functionality of UI Customizer.\u005cn\u005cnEither disable UI Customizer or OctoPrint-WideScreen plugin for optimal performance.',\u000a                    'action' : function(){\u000a                        if (!$('#settings_dialog:visible').length){\u000a                            $('#navbar_show_settings').trigger('click');\u000a                            $('#settings_plugin_pluginmanager_link a').trigger('click');\u000a                        }\u000a                    }\u000a                },\u000a                'consolidate_temp_control': {\u000a                    'text': 'Running the plugins Consolidate Temp Control and UI Customizer together can cause problems.\u005cn\u005cnThe UI Customizer plugin has tried to fix these problems but there might be layout issues.',\u000a                    'action' : null\u000a                },\u000a            }\u000a\u000a            // Notify options main options\u000a            var options = {\u000a                title: "Plugin compatibility issue",\u000a                text: "",\u000a                type: "notice",\u000a                hide: false,\u000a                confirm: {\u000a                    confirm: true,\u000a                    buttons: [\u000a                        {\u000a                            text: gettext("Cancel"),\u000a                            click: function (notice) {\u000a                                notice.remove();\u000a                                notice.get().trigger("pnotify.cancel", notice);\u000a                            }\u000a                        }\u000a                    ]\u000a                },\u000a                buttons: {sticker: false,closer: false}\u000a            };\u000a\u000a            // Check for any issues with installed plugins\u000a            $.each(knowPluginIssues,function(key,val){\u000a                if (typeof OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins[key] !== "undefined"){\u000a                    self.logToConsole("Plugin issues detected: " + key);\u000a                    if (val.action != null){\u000a                        var optionsCust = $.extend(true,{},options);\u000a                        optionsCust.text = val.text;\u000a                        optionsCust.confirm.buttons.unshift({\u000a                            text: gettext("Open"),\u000a                            click: function (notice) {\u000a                                val.action();\u000a                                notice.close();\u000a                            }\u000a                        });\u000a                        new PNotify(optionsCust);\u000a                    }else{\u000a                        new PNotify({\u000a                          title: options.title,\u000a                          text: val.text,\u000a                          hide: false\u000a                        });\u000a                    }\u000a                }\u000a            });\u000a\u000a            // Refresh all\u000a            window.setTimeout(function() {\u000a                $(window).trigger('resize');\u000a            },500);\u000a        }\u000a\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Update the entire layout\u000a        self.UpdateLayout= function(settingsPlugin){\u000a\u000a            self.logToConsole('Updating UI/layout');\u000a            // Remove widths if any\u000a            $('div.UICmainTabs').removeClass('span8');\u000a            $('#sidebar').removeClass('span4');\u000a\u000a            // Fixed header\u000a            self.set_fixedHeader(settingsPlugin.fixedHeader());\u000a\u000a            // Fixed footer\u000a            self.set_fixedFooter(settingsPlugin.fixedFooter());\u000a\u000a            // remove graph background\u000a            self.set_hideGraphBackground(settingsPlugin.hideGraphBackground());\u000a\u000a            // Make it fluid\u000a            self.set_fluidLayout(settingsPlugin.fluidLayout());\u000a\u000a\u000a            // Run in responsive mode\u000a            self.set_responsiveMode(settingsPlugin.responsiveMode());\u000a\u000a            // Center the icons\u000a            self.set_centerTopIcons(settingsPlugin.centerTopIcons());\u000a\u000a            // Fix temp bar plugin\u000a            self.set_navbarplugintempfix(settingsPlugin.navbarplugintempfix());\u000a\u000a            // Compact menus\u000a            self.set_compactMenu(settingsPlugin.compactMenu());\u000a\u000a            // BUild the main layout\u000a            self.set_mainLayout(settingsPlugin);\u000a\u000a            // Customize tabs\u000a            self.set_mainTabsCustomize(settingsPlugin.mainTabsCustomize(),settingsPlugin.mainTabs());\u000a\u000a            // Sort top icons\u000a            self.set_sortTopIcons(settingsPlugin.topIconSort());\u000a\u000a            // Hide main cams\u000a            self.set_hideMainCam(self.settings.settings.plugins.uicustomizer.hideMainCam());\u000a\u000a            // add webcam zoom option\u000a            self.set_addWebCamZoom(settingsPlugin.addWebCamZoom());\u000a\u000a            // Full widh Gcode\u000a            self.set_gcodeFullWidth(settingsPlugin.gcodeFullWidth());\u000a\u000a            // Compress the temperature controls\u000a            self.set_compressTempControls(settingsPlugin.compressTempControls());\u000a\u000a            // Update themes\u000a            if (self.updateThemify(null) == false){\u000a                self.updateStandardTheme(OctoPrint.coreui.viewmodels.settingsViewModel.settings.appearance.color());\u000a            };\u000a\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        self.updateStandardTheme = function(curTheme){\u000a            if (curTheme == "default"){\u000a                // Cleanup\u000a                self.logToConsole("Removing standard theme mods");\u000a                $('html').addClass('UICDefaultTheme');\u000a                $('#UICCustStandardTheme').remove();\u000a            }else{\u000a                $('html').removeClass('UICDefaultTheme');\u000a                self.logToConsole("Standard theme is: " + curTheme);\u000a                if ($('#UICCustStandardTheme').length){\u000a                    self.logToConsole("Standard theme mods founnd");\u000a                }else{\u000a                    self.logToConsole("Standard theme mods added");\u000a                    $('head').append('<style type="text/css" id="UICCustStandardTheme"/>');\u000a                }\u000a                // Find the style sheet\u000a                var hasCompact = $('div.UICMainMenu').hasClass('UICCompactMenu');\u000a                var hasResponsive = $('body').hasClass('UICResponsiveMode');\u000a                var cleanRep = new RegExp('\u005c.'+curTheme, "gi");\u000a                var newStyle = '';\u000a                var styleSrc = false;\u000a                if ($('link[href^="/static/webassets/packed_core.css"][rel="stylesheet"]').length){\u000a                    styleSrc = $('link[href^="/static/webassets/packed_core.css"][rel="stylesheet"]');\u000a                }else if ($('link[href="/static/css/octoprint.css"][rel="stylesheet"]').length){\u000a                    styleSrc = $('link[href="/static/css/octoprint.css"][rel="stylesheet"]');\u000a                }\u000a                if (styleSrc == false){\u000a                    self.logToConsole("Standard theme css src not found!");\u000a                    return;\u000a                }\u000a                $.each(styleSrc[0].sheet.cssRules,function(){\u000a                    var cssSel = this.selectorText;\u000a                    if (cssSel != undefined && cssSel.indexOf('#navbar .navbar-inner.'+curTheme) != -1){\u000a                        newStyle += this.cssText.replace(/#navbar/gi,'#page-container-main > div.footer').replace(cleanRep,'');\u000a                        if (hasCompact){\u000a                            newStyle += this.cssText.replace(/#navbar \u005c.navbar-inner/gi,'div.UICMainMenu.UICCompactMenu').replace(cleanRep,'');\u000a                        }\u000a                        if (hasResponsive){\u000a                            newStyle += this.cssText.replace(/#navbar/gi,'#UICsettingsMenuNav').replace(cleanRep,'');\u000a                        }\u000a                    };\u000a                });\u000a                newStyle = newStyle.replace(/background-image: url.+?;/gmi,'');\u000a\u000a                $('#UICCustStandardTheme').text(newStyle)\u000a                delete newStyle;\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        self.updateThemify = function(curTheme){\u000a            if (!OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.hasOwnProperty('themeify') || OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.themeify.enabled() == false){\u000a                self.logToConsole("Removing themeify theme mods");\u000a                $('#UICCustThemeify').remove();\u000a                return false;\u000a            }\u000a\u000a            // Remove default theme\u000a            $('html').removeClass('UICDefaultTheme');\u000a            // remove octoprint theme mods\u000a            $('#UICCustStandardTheme').remove();\u000a\u000a            // Get the current theme from themify\u000a            if (curTheme == null){\u000a                curTheme = OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.themeify.theme();\u000a            }\u000a            // Build our copy\u000a            self.logToConsole("themeify theme is: " + curTheme);\u000a            if ($('#UICCustThemeify').length){\u000a                self.logToConsole("themeify theme mods founnd");\u000a            }else{\u000a                self.logToConsole("themeify theme mods added");\u000a                $('head').append('<style type="text/css" id="UICCustThemeify"/>');\u000a            }\u000a\u000a            // Find the style sheets\u000a            var hasCompact = $('div.UICMainMenu').hasClass('UICCompactMenu');\u000a            var hasResponsive = $('body').hasClass('UICResponsiveMode');\u000a            var cleanRep = new RegExp('\u005c.'+curTheme, "gi");\u000a            var navbarClean = new RegExp('\u005c.themeify\u005c.'+curTheme+' #navbar', "gi");\u000a            var newStyle = '';\u000a            var bgcolor = '';\u000a            var styleSrc = false;\u000a            if ($('link[href^="/static/webassets/packed_plugins.css"][rel="stylesheet"]').length){\u000a                styleSrc = $('link[href^="/static/webassets/packed_plugins.css"][rel="stylesheet"]');\u000a            }else if ($('link[href="/plugin/themeify/static/dist/themeify.min.css"][rel="stylesheet"]').length){\u000a                styleSrc = $('link[href="/plugin/themeify/static/dist/themeify.min.css"][rel="stylesheet"]');\u000a            }\u000a            if (styleSrc == false){\u000a                self.logToConsole("Themeify css src not found!");\u000a                return;\u000a            }\u000a            $.each(styleSrc[0].sheet.cssRules,function(){\u000a                var cssSel = this.selectorText;\u000a                if (cssSel != undefined && cssSel.indexOf('.themeify.'+curTheme+' #navbar .navbar-inner') != -1){\u000a                    newStyle += this.cssText.replace(navbarClean,'#page-container-main > div.footer').replace(cleanRep,'');\u000a                    if (hasCompact){\u000a                        newStyle += this.cssText.replace(/#navbar \u005c.navbar-inner/gi,'div.UICMainMenu.UICCompactMenu').replace(cleanRep,'');\u000a                    }\u000a                    if (hasResponsive){\u000a                        newStyle += this.cssText.replace(/#navbar/gi,'#UICsettingsMenuNav').replace(cleanRep,'');\u000a                    }\u000a                };\u000a                if (bgcolor == '' && cssSel != undefined && cssSel.indexOf('.themeify.'+curTheme+' .modal') != -1 && this.cssText.indexOf('background-color') != -1){\u000a                    var regBack = /background-color:(.*);/gmi;;\u000a                    var matches = regBack.exec(this.cssText);\u000a                    var matchstr = matches[1]+";";\u000a                    bgcolor = $.trim(matchstr.slice(0, matchstr.indexOf(';')));\u000a                };\u000a            });\u000a            if (bgcolor != ""){\u000a                var bgcolorClean = bgcolor.slice(bgcolor.indexOf('(')+1);\u000a                bgcolorClean = bgcolorClean.slice(0,bgcolorClean.indexOf(')'));\u000a                newStyle += '\u005c\u000a                    html.'+curTheme+' #UICsettingsMenuNav{\u005c\u000a                        background-color:'+bgcolor+';\u005c\u000a                        background: linear-gradient(180deg, rgba('+bgcolorClean+',1) 0px, rgba('+bgcolorClean+',1) 55px, rgba('+bgcolorClean+',0) 100%);\u005c\u000a                    }\u005c\u000a                ';\u000a            }\u000a            $('#UICCustThemeify').text(newStyle);\u000a\u000a            delete newStyle;\u000a            return true;\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        self.set_mainLayout = function(settingsPlugin){\u000a            // Fix layout and width - using magic\u000a            var TempCols = [...settingsPlugin.rows()];\u000a\u000a            // Check for empty object\u000a            if($.isEmptyObject(TempCols[0])){\u000a                new PNotify({title:"UI Customizer failure", type: "error","text":"Failed to load proper settings for layout.\u005cnSorry :(","hide":false});\u000a                console.log(TempCols);\u000a                return true;\u000a            }\u000a            var widths = settingsPlugin.widths();\u000a\u000a            // Build only visible items in a simple array\u000a            var CleanedCols = [];\u000a            $.each(TempCols,function(colID,items){\u000a                CleanedCols[colID] = [];\u000a                $.each(items, function(widgetid,shown){\u000a                    // Fix function missing\u000a                    if (typeof shown == "function"){\u000a                        shown = shown();\u000a                    }\u000a                    // Remove prefixes - they are added to keep the order in json object\u000a                    if (widgetid.charAt(0) == "_"){\u000a                        self.logToConsole("Slicing 3 chars of: " + widgetid);\u000a                        widgetid = widgetid.slice(3);\u000a                        self.logToConsole("new widgetid: " + widgetid);\u000a                    }\u000a                    self.logToConsole("Building collumn " +colID + ": " + widgetid + (shown?" Adding":" Hiding"));\u000a                    // Add the widgets if visible or in custom list\u000a                    if (shown && ($(widgetid).length || self.customWidgets.hasOwnProperty(widgetid))){\u000a                        CleanedCols[colID].push(widgetid);\u000a                        $(widgetid).removeClass('UICHide');\u000a                    }else{\u000a                        // Hide the widget if not requested to be shown\u000a                        $(widgetid).addClass('UICHide');\u000a                        self.logToConsole("Hiding widget:" + widgetid);\u000a                    }\u000a                });\u000a            });\u000a\u000a            // Remove empty right cols and bit of magic\u000a            var cols = [];\u000a            var colFound = false;\u000a            CleanedCols.reverse();\u000a            $(CleanedCols).each(function(key,val){\u000a                if (val.length > 0 || colFound){\u000a                    colFound = true;\u000a                    cols.push(val);\u000a                }else{\u000a                    // Find the column index in the reversed order and mark them for deletion - we can just delete empty ones because we can have an empty filler\u000a                    var keyRevFix = Math.abs(2-key)+1;\u000a                    $('div.UICCol'+keyRevFix).addClass('UICColDELETEME');\u000a                }\u000a            });\u000a            cols.reverse();\u000a            self.logToConsole('Building '+cols.length+ ' columns layouts:' + JSON.stringify(cols));\u000a\u000a            // Build the layout requested\u000a            $(cols).each(function(key,val){\u000a                var keyoffset = key+1;\u000a                // Set width\u000a                var spanW = widths[key];\u000a\u000a                // Add if not built yet\u000a                if ($('div.UICCol'+keyoffset).length == 0){\u000a                    $('div.UICMainCont > div:first').append('<div class="accordion UICCol'+keyoffset+'"></div>');\u000a                }\u000a\u000a                // Remove and set span width\u000a                if (!$('div.UICCol'+keyoffset).hasClass('span'+spanW)){\u000a                    $('div.UICCol'+keyoffset).attr('class', function(i, c){\u000a                        return c.replace(/(^|\u005cs)span\u005cd+/g, '');\u000a                    });\u000a                    $('div.UICCol'+keyoffset).addClass('span'+spanW);\u000a                    if (spanW >= 6){\u000a                        $('div.UICCol'+keyoffset).addClass('UICLargeSpan');\u000a                    }\u000a                }\u000a\u000a                // Add items\u000a                $(val).each(function(key2,val2){\u000a                    if ($(val2).length){\u000a                        // Append to UI\u000a                        self.logToConsole('Adding standard widget "'+val2+'" to column '+keyoffset);\u000a                        $(val2).appendTo('div.UICCol'+keyoffset);\u000a                    // Append custom widgets\u000a                    }else if (self.customWidgets.hasOwnProperty(val2)){\u000a                        self.logToConsole('Adding custom widget "'+val2+'" to column '+keyoffset);\u000a                        $(self.customWidgets[val2].dom).appendTo('div.UICCol'+keyoffset);\u000a                    }else{\u000a                        self.logToConsole('Skipping widget "'+val2+'"');\u000a                    }\u000a\u000a                    // Init custom widget\u000a                    if (self.customWidgets.hasOwnProperty(val2) && 'init' in self.customWidgets[val2] && typeof self[self.customWidgets[val2].init] == "function"){\u000a                        self.logToConsole('Launching custom widget "'+val2+'" js init');\u000a                        self[self.customWidgets[val2].init](true);\u000a                    }\u000a                });\u000a            });\u000a\u000a            // Remove marked for delition\u000a            $('div.UICColDELETEME').remove();\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        self.set_sortTopIcons = function(iconsort){\u000a            var iconsortTmp = [...iconsort];\u000a            if (iconsortTmp.length == 0){\u000a                self.logToConsole('No topIcons to sort');\u000a                return true;\u000a            }\u000a            // Which container are we using\u000a            if ($('ul.UICHeaderIcons').length){\u000a                self.logToConsole('Sorting top icons: UICHeaderIcons');\u000a                var container = $('ul.UICHeaderIcons');\u000a            }else{\u000a                self.logToConsole('Sorting top icons: UICMainMenu');\u000a                var container = $('div.UICMainMenu ul.nav');\u000a            }\u000a            iconsortTmp.reverse();\u000a            $.each(iconsortTmp,function(x,idx){\u000a                self.logToConsole('Sorting top icons - adding: '+idx);\u000a                container.prepend($('#'+idx));\u000a            });\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        self.get_TopIcons = function(){\u000a            if ($('ul.UICHeaderIcons').length){\u000a                return $('ul.UICHeaderIcons >li').map(function(){return $(this).attr('id')}).get();\u000a            }else{\u000a                return $('div.UICMainMenu ul.nav > li[id^="navbar_plugin"]:not(.UICExcludeFromTopIcons)').map(function(){return $(this).attr('id')}).get();\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        self.set_mainTabsCustomize = function(enable,tabsSource){\u000a            if (enable){\u000a                var tabsData = self.initTabs(tabsSource);\u000a                // Build an index based lookup\u000a                var indexobj = tabsData[0];\u000a                var listItems = tabsData[1];\u000a\u000a                $.each(listItems,function(idx,val){\u000a                    $('#tabs').append($('#'+val));\u000a                    self.buildCustomTab(indexobj[val]);\u000a                });\u000a            }else{\u000a                $('#tabs li:not(.tabdrop) a >i').remove();\u000a                var orgSort = [];\u000a                $('#tabs li:not(.tabdrop) a').each(function(){\u000a                    if ($(this).data('orgName') != undefined){\u000a                        $(this).text($(this).data('orgName'));\u000a                    }\u000a                    if ($(this).data('orgPos') != undefined){\u000a                        orgSort[$(this).data('orgPos')] = $(this).parent().attr('id');\u000a                    }else{\u000a                        orgSort.push($(this).parent().attr('id'));\u000a                    }\u000a                });\u000a                if (orgSort.length > 0){\u000a                     $.each(orgSort,function(idx,val){\u000a                        $('#tabs').append($('#'+val));\u000a                    });\u000a                }\u000a            }\u000a            // Trigger tabover\u000a            $('#tabs').trigger('resize');\u000a        }\u000a\u000a\u000a        self.set_gcodeFullWidth= function(enable){\u000a            if (enable){\u000a                $('#canvas_container').addClass('UICMaxi');\u000a            }else{\u000a                $('#canvas_container').removeClass('UICMaxi');\u000a            }\u000a        }\u000a\u000a        self.set_compressTempControls= function(enable){\u000a            if (enable){\u000a                $('#temp').addClass('UICTempTableSmall');\u000a            }else{\u000a                $('#temp').removeClass('UICTempTableSmall');\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        self.set_addWebCamZoom = function(enable){\u000a            var streamURL = self.settings.webcam_streamUrl();\u000a            if (!enable || (self.settings.webcam_webcamEnabled() == false || streamURL == "")){\u000a                $('div.UICWebCamClick').remove();\u000a                return true;\u000a            }\u000a\u000a            // drag handler - http://jsfiddle.net/robertc/kKuqH/\u000a            var dragstart = function (event) {\u000a                $('#drop_overlay').addClass('UICHideHard');\u000a                var style = window.getComputedStyle(event.target, null);\u000a                $('#drop_overlay').data('positionData',[(parseInt(style.getPropertyValue("left"),10) - event.clientX),(parseInt(style.getPropertyValue("top"),10) - event.clientY)]);\u000a            }\u000a            var drag_over = function(event) {\u000a                // Avoid conflict with dropzone uploading\u000a                if ($('#drop_overlay').hasClass('UICHideHard')){\u000a                    event.preventDefault();\u000a                    return false;\u000a                }\u000a            }\u000a            var drop = function(event) {\u000a                // Avoid conflict with dropzone uploading\u000a                if(!$(event.target).hasClass('dropzone')){\u000a                    var offset = $('#drop_overlay').data('positionData');\u000a                    var dm = document.getElementById('UICWebCamFull');\u000a                    dm.style.left = (event.clientX + parseInt(offset[0],10)) + 'px';\u000a                    dm.style.top = (event.clientY + parseInt(offset[1],10)) + 'px';\u000a                    $('#drop_overlay').removeClass('UICHideHard in');\u000a                    event.preventDefault();\u000a                    return false;\u000a                }\u000a            }\u000a\u000a            // HLS handling\u000a            var hlsCam = false;\u000a            var containers = ['#webcam_container','#IUCWebcamContainer > div'];\u000a            if (/.m3u8/i.test(streamURL)){\u000a                hlsCam = true;\u000a                containers = ['#webcam_hls_container','#IUCWebcamContainer > div'];\u000a                // fix position of hls\u000a                $('#webcam_hls_container').css('position','relative');\u000a                $('#webcam_container img').attr('src','data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7');\u000a                $('#webcam_container').hide();\u000a            }else{\u000a                $('#webcam_hls_container video').attr('src','');\u000a                $('#webcam_hls_container').hide();\u000a            }\u000a\u000a            // Remove all zoom classes\u000a            $('.UIWebcamZoomSrc').removeClass('UIWebcamZoomSrc');\u000a\u000a            // Append containers to all webcams\u000a            $('div.UICWebCamClick').not('#UICWebCamFull > div.UICWebCamClick').remove();\u000a            $.each(containers,function(i,idx){\u000a                var obj = $(idx);\u000a\u000a                // Skip hidden\u000a                if (obj.hasClass('UICHideHard')){\u000a                    return true;\u000a                }\u000a\u000a                obj.addClass('UIWebcamZoomSrc');\u000a                var zoomclick = $('<div class="UICWebCamClick"><a href="javascript:void(0);"><i class="fas fa-expand"></i></a></div>');\u000a                obj.prepend(zoomclick);\u000a                if (!self.previewOn){\u000a                    zoomclick.hide();\u000a                }\u000a                // Double click\u000a                obj.off('dblclick').on('dblclick',function(){\u000a                    zoomclick.trigger('click.UICWebCamClick');\u000a                });\u000a                zoomclick.off('click.UICWebCamClick').on('click.UICWebCamClick',function(){\u000a                    var streamURL = self.settings.webcam_streamUrl();\u000a                    var hlsCam = false;\u000a                    if (/.m3u8/i.test(streamURL)){\u000a                        hlsCam = true;\u000a                    }\u000a                    $('.UIWebcamZoomSrc').hide();\u000a                    // Remove previous if any\u000a                    $('#UICWebCamFull').remove();\u000a\u000a                    // Append floating cam to body\u000a                    $('body').append('<div id="UICWebCamFull" draggable="true" class="UICWebcam"><div class="nowebcam text-center"><i class="fas fa-spinner fa-spin"></i> <span class="UIC-pulsate">Loading webcam&hellip;</span></div><div id="UICWebCamShrink" class="UICWebCamClick"><a href="javascript: void(0);"><i class="fas fa-compress"></i></a></div><div class="UICWebCamTarget"></div></div>');\u000a                    $('#UICWebCamShrink').hide();\u000a\u000a                    // Set top offset\u000a                    if ($(window).scrollTop() > 0){\u000a                        $('#UICWebCamFull').css('top',$(window).scrollTop()+$('#UICWebCamFull').height());\u000a                    }\u000a\u000a                    // Set source item\u000a                    if (hlsCam){\u000a                        // Fix and setup video\u000a                        $('#UICWebCamFull div.UICWebCamTarget').replaceWith('<video muted="" autoplay=""></video>');\u000a                        $('#UICWebCamFull video').off('playing.UICCam').on('playing.UICCam',function(event){\u000a                            $('#UICWebCamShrink').show();\u000a                            $('#UICWebCamFull div.nowebcam').remove();\u000a                        });\u000a                        // Add hls player\u000a                        var video = $('#UICWebCamFull video')[0];\u000a                        self.startHLSstream(video,streamURL);\u000a\u000a                        // Tired of waiting\u000a                        window.setTimeout(function(){\u000a                            $('#UICWebCamShrink').show();\u000a                            $('#UICWebCamFull div.nowebcam').remove();\u000a                        },5000);\u000a\u000a                    }else{\u000a                        var rotated = $('#webcam_rotator').hasClass('webcam_rotated');\u000a                        var imgsrc = obj.find('img')[0];\u000a                        if (rotated){\u000a                            var nHeight = imgsrc.naturalWidth;\u000a                            var nWidth = imgsrc.naturalHeight;\u000a                        }else{\u000a                            var nWidth = imgsrc.naturalWidth;\u000a                            var nHeight = imgsrc.naturalHeight;\u000a                        }\u000a                        var aspect = nWidth/nHeight;\u000a                        // Resize a bit\u000a                        nWidth -= 100;\u000a                        nHeight = nWidth/aspect;\u000a                        // Inside window or not?\u000a                        var fixed = false;\u000a                        var wWidth = $(window).width();\u000a                        var wHeight = $(window).height();\u000a                        // Cam wider than screen - then fit to screen width\u000a                        if (nWidth > wWidth){\u000a                            fixed = true;\u000a                            nWidth = (wWidth - 120);\u000a                            nHeight = nWidth/aspect;\u000a                        }\u000a                        if (nHeight > wHeight){\u000a                            fixed = true;\u000a                            nHeight = (wHeight - 120);\u000a                            nWidth = nHeight*aspect;\u000a                        }\u000a\u000a                        var clone = $('#webcam_rotator').clone();\u000a                        clone.find('>div:not(:first-child)').remove();\u000a                        clone.attr('id','UICWebCamFullInnerDIV');\u000a                        clone.find('*').removeAttr('id').removeAttr('data-bind');\u000a                        clone.find('img').off('load');\u000a                        clone.find('img').attr('src','data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7');\u000a                        $('#UICWebCamFull img').off('load');\u000a                        $('#UICWebCamFull div.UICWebCamTarget').html(clone.html());\u000a                        if (rotated){\u000a                            $('#UICWebCamFull div.UICWebCamTarget').addClass('webcam_rotated');\u000a                            $('#UICWebCamFull').css('max-height','initial');\u000a                            $('#UICWebCamFull').css('max-width','initial');\u000a                        }\u000a\u000a                        // Tired of waiting\u000a                        var timeoutLoad = window.setTimeout(function(){\u000a                            $('#UICWebCamFull img').trigger('load',[true]);\u000a                        },5000);\u000a\u000a                        // Fix sizing\u000a                        $('#UICWebCamFull img').css({'width':nWidth});\u000a                        $('#UICWebCamFull img').css({'height':nHeight});\u000a\u000a                        // Set max if needed\u000a                        if (!fixed){\u000a                            $('#UICWebCamFull img').css({'max-width':$(window).width()-120});\u000a                            $('#UICWebCamFull img').css({'max-height':$(window).height()-120});\u000a                        }\u000a                        // Load it\u000a                        $('#UICWebCamFull img').off('load').on('load',function(event,forced){\u000a                            if (streamURL != $(this).attr('src')){\u000a                                if (forced){\u000a                                    $(this).attr('src',streamURL);\u000a                                }else{\u000a                                    return false;\u000a                                }\u000a                                return false;\u000a                            }else{\u000a                                $('#UICWebCamFull img').off('load');\u000a                            }\u000a                            if (timeoutLoad != null){\u000a                                window.clearTimeout(timeoutLoad);\u000a                                timeoutLoad = null;\u000a                            };\u000a                            $('#UICWebCamShrink').show();\u000a                            $('#UICWebCamFull img').show();\u000a                            $('#UICWebCamFull div.nowebcam').remove();\u000a                            // Set the size i running a fixed size\u000a                            if (fixed){\u000a                                $('#UICWebCamFull').css({'width':nWidth+10});\u000a                            }\u000a                            $('#UICWebCamFull img').css({'width':''});\u000a                            $('#UICWebCamFull img').css({'height':''});\u000a                        });\u000a                        $('#UICWebCamFull img').attr('src',streamURL);\u000a                    }\u000a\u000a                    // Fix on resize done\u000a                    $('#UICWebCamFull').off('mouseup').on('mouseup',function(){\u000a                        $('#UICWebCamFull img').css({'width':''});\u000a                        $('#UICWebCamFull img').css({'height':''});\u000a                        $('#UICWebCamFull').css('height','');\u000a                    }).off('dblclick').on('dblclick',function(){\u000a                        $('#UICWebCamShrink').trigger('click');\u000a                    }).off('resize').on('resize',function(){\u000a                        // Resize timer\u000a                        if ($(this).data("resizeTimer") != undefined){\u000a                            clearTimeout($(this).data("resizeTimer"));\u000a                        }\u000a                        $(this).data("resizeTimer",window.setTimeout(function(){\u000a                            $('#UICWebCamFull').trigger('mouseup');\u000a                        },500));\u000a                    });\u000a\u000a                    // Start draghandler\u000a                    var dm = document.getElementById('UICWebCamFull');\u000a                    $('#UICWebCamFull').on('dragstart.UICCam',dragstart);\u000a                    $('body').on('dragover.UICCam',drag_over);\u000a                    $('body').on('drop.UICCam',drop);\u000a\u000a                    // Close again\u000a                    $('#UICWebCamShrink').one('click',function(){\u000a                        $('#UICWebCamFull').off('dragstart.UICCam');\u000a                        $('body').off('dragover.UICCam');\u000a                        $('body').off('drop.UICCam');\u000a                        $('#drop_overlay').removeClass('UICHideHard in');\u000a                        $('.UIWebcamZoomSrc').show();\u000a                        $('#UICWebCamFull').remove();\u000a                    });\u000a\u000a                    // Todo: add styling for fullscreen and add overlays with print info and gcode preview etc. https://www.w3schools.com/howto/howto_js_fullscreen.asp\u000a                    // self.openFullscreen(document.getElementById('UICWebCamFull'));\u000a                });\u000a            });\u000a        }\u000a\u000a        /*https://www.w3schools.com/howto/howto_js_fullscreen.asp*/\u000a        /* View in fullscreen */\u000a        self.openFullscreen = function(elem){\u000a            if (elem.requestFullscreen) {\u000a                elem.requestFullscreen();\u000a            } else if (elem.webkitRequestFullscreen) { /* Safari */\u000a                elem.webkitRequestFullscreen();\u000a            } else if (elem.msRequestFullscreen) { /* IE11 */\u000a                elem.msRequestFullscreen();\u000a            }\u000a        }\u000a\u000a        /* Close fullscreen */\u000a        self.closeFullscreen = function(){\u000a            if (document.exitFullscreen) {\u000a                document.exitFullscreen();\u000a            } else if (document.webkitExitFullscreen) { /* Safari */\u000a                document.webkitExitFullscreen();\u000a            } else if (document.msExitFullscreen) { /* IE11 */\u000a                document.msExitFullscreen();\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Hide main cams\u000a        self.set_hideMainCam = function(enable){\u000a            if (enable){\u000a                if ($('#webcam_image').data("isHidden") === true){\u000a                    self.logToConsole("Main cam already hidden");\u000a                    return true;\u000a                }\u000a                if ($('#webcam_hls').length){\u000a                    $('#webcam_hls_container').addClass('UICHideHard');\u000a                    $('#webcam_hls')[0].pause();\u000a                }\u000a                $('#webcam_container').addClass('UICHideHard');\u000a                $('#webcam_container').next().addClass('UICHideHard');\u000a                $('#webcam_image').attr('src','data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7');\u000a                $('#webcam_image').data("isHidden",true);\u000a            }else{\u000a                if ($('#webcam_image').data("isHidden") === false){\u000a                    self.logToConsole("Main cam is already shown");\u000a                    return true;\u000a                }\u000a                if ($('#webcam_hls').length){\u000a                    $('#webcam_hls_container').removeClass('UICHideHard');\u000a                }\u000a                $('#webcam_container').removeClass('UICHideHard');\u000a                $('#webcam_container').next().removeClass('UICHideHard');\u000a                $('#webcam_image').data("isHidden",false);\u000a            }\u000a        }\u000a\u000a        self.CustomW_initGcode = function(enable){\u000a            self.getReturnData = enable;\u000a            if (enable){\u000a                $('#UICGcodeVWidget ul.dropdown-menu a').off('click').on('click',function(event,dontLoad){\u000a                    $('#UICGcodeVWidget  ul.dropdown-menu li.active').removeClass('active');\u000a                    $(this).parent().addClass('active');\u000a                    $('#UICGcodeVWidgetZL').text($(this).text());\u000a                    $('#UICGcodeVWidget').data('zoomlvl',$(this).data('zoomlvl'));\u000a                    // Save the settings\u000a                    OctoPrint.settings.savePluginSettings('uicustomizer',{'gcodeZoom':$(this).data('zoomlvl')})\u000a                });\u000a                if (typeof self.settings.settings.plugins.uicustomizer.gcodeZoom == "undefined" && $('#UICGcodeVWidget ul.dropdown-menu a[data-zoomlvl="'+self.settings.settings.plugins.uicustomizer.gcodeZoom()+'"]').length == 0){\u000a                    $('#UICGcodeVWidget ul.dropdown-menu a:first').trigger('click');\u000a                }else{\u000a                    $('#UICGcodeVWidget ul.dropdown-menu a[data-zoomlvl="'+self.settings.settings.plugins.uicustomizer.gcodeZoom()+'"]').trigger('click')\u000a                }\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        self.CustomW_initWebCam = function(enable){\u000a            self.logToConsole('WebCam custom init');\u000a\u000a            // Hide main cams\u000a            self.set_hideMainCam(self.settings.settings.plugins.uicustomizer.hideMainCam());\u000a\u000a            // Disable it all\u000a            if (!enable){\u000a                 // Remove subscribe\u000a                 if ($('body').data("webcamSubscribed") != undefined){\u000a                    $('body').data("webcamSubscribed").dispose();\u000a                    $('body').removeData("webcamSubscribed");\u000a                 }\u000a                 OctoPrint.coreui.viewmodels.controlViewModel.onWebcamLoaded = self.onWebCamOrg;\u000a                 OctoPrint.coreui.viewmodels.controlViewModel.onWebcamErrored = self.onWebCamErrorOrg;\u000a                 $('#UICWebCamWidget').remove();\u000a                 return true;\u000a            }\u000a\u000a            // Cleanup\u000a            $('#IUCWebcamContainer > div').html('');\u000a            var hlsCam = false;\u000a            var streamURL = self.settings.webcam_streamUrl();\u000a\u000a            // Not configured - then do nothing\u000a            if (self.settings.webcam_webcamEnabled() == false || streamURL == ""){\u000a                $('#IUCWebcamContainer > div').append('<div class="nowebcam text-center"><i class="fas fa-question"></i> <span>Webcam not configured&hellip;</span></div>');\u000a                self.CustomW_initWebCam(false);\u000a                return true;\u000a            }\u000a\u000a            // Check for multicam\u000a            if (OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.hasOwnProperty('multicam') && OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.multicam.multicam_profiles().length > 1 && !$('.UICMultiCamSelector').length ){\u000a                var multicamSelector = $('<div class="btn-group UICMultiCamSelector UICWidgetSelector"><a class="btn btn-small dropdown-toggle" data-toggle="dropdown" href="#"><span id="UICMultiCamLbl">Cam</span><span class="caret"></span></a><ul class="dropdown-menu"></ul></div>');\u000a                var ulCamSel = multicamSelector.find('ul');\u000a                $.each(OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.multicam.multicam_profiles(),function(idx,item){\u000a                    // Set the label\u000a                    var className = '';\u000a                    if (idx == 0){\u000a                        multicamSelector.find('span:first').text(item.name());\u000a                        className = ' class="active" ';\u000a                    }\u000a                    // Build the selector\u000a                    ulCamSel.append($('<li'+className+' data-streamURL="'+item.URL()+'"><a href="#">'+item.name()+'</a></li>').on('click','a',function(event,dontLoad){\u000a                        $('.UICMultiCamSelector li.active').removeClass('active');\u000a                        $(this).parent().addClass('active');\u000a                        $('#UICMultiCamLbl').text(item.name());\u000a                        if(dontLoad !== true){\u000a                            OctoPrint.coreui.viewmodels.multiCamViewModel.loadWebcam(item);\u000a                        }\u000a                    }));\u000a                })\u000a                $('#UICWebCamWidget div.accordion-heading').append(multicamSelector);\u000a            }\u000a\u000a            // BROKEN due to loading/changes not triggering at the right time: || (typeof OctoPrint.coreui.viewmodels.controlViewModel.webcamHlsEnabled == "function" && OctoPrint.coreui.viewmodels.controlViewModel.webcamHlsEnabled()\u000a            if (/.m3u8/i.test(streamURL)){\u000a                self.logToConsole("HLS WebCam detected: " + streamURL);\u000a                hlsCam = true;\u000a            }\u000a\u000a            // Fix changes - this fixes also multicam etc.\u000a            if ($('body').data("webcamSubscribed") == undefined){\u000a                var subs = OctoPrint.coreui.viewmodels.settingsViewModel.webcam_streamUrl.subscribe(function(streamURL) {\u000a                    if ($('#settings_dialog:visible').length){\u000a                        self.logToConsole("Webcam url changed inside settings - skipping!");\u000a                        return true;\u000a                    }\u000a\u000a                    // Update dropdown for multicam\u000a                    if ($('.UICMultiCamSelector').length){\u000a                        $('.UICMultiCamSelector li.active').removeClass('active');\u000a                        $('.UICMultiCamSelector li[data-streamurl="'+streamURL+'"]:first a').trigger('click',[true]);\u000a                    }\u000a\u000a                    // Change URL\u000a                    self.logToConsole("Webcam URL changed to: "+streamURL);\u000a                    if (/.m3u8/i.test(streamURL)){\u000a                        // We are switching to HLS or not?\u000a                        if (!$('#IUCWebcamContainer video').length){\u000a                            self.logToConsole("Webcam is switching from IMG to HLS format");\u000a                            self.CustomW_initWebCam(enable);\u000a                            return true;\u000a                        }\u000a                        if ($('#IUCWebcamContainer video').data('streamURL').indexOf(streamURL) != 0){\u000a                            self.logToConsole("Webcam HLS stream triggered - Starting: " + streamURL);\u000a                            $('#IUCWebcamContainer video').data('streamURL',streamURL);\u000a                            $('#IUCWebcamContainer video').data('playing',true);\u000a                            // Start HLS player - a seperate stream is better - tried canvas copy etc.\u000a                            var video = $('#IUCWebcamContainer video')[0];\u000a                            self.startHLSstream(video,streamURL);\u000a                        }else{\u000a                            self.logToConsole("Webcam HLS stream triggered same URL: " + streamURL + "/"+$('#IUCWebcamContainer video').data('streamURL'));\u000a                        }\u000a                    }else{\u000a                        var imgsrc = $('#IUCWebcamContainerInner img');\u000a                        // We are switching to HLS or not?\u000a                        if (!imgsrc.length){\u000a                            self.logToConsole("Webcam is switching from HLS to IMG format");\u000a                            self.CustomW_initWebCam(enable);\u000a                            return true;\u000a                        }\u000a                        if (imgsrc.attr('src').indexOf(streamURL) != 0){\u000a                            self.logToConsole("Webcam IMG stream triggered - Starting: " + streamURL);\u000a                            webcamLoader(streamURL);\u000a                            imgsrc.attr('src',streamURL);\u000a                        }else{\u000a                            self.logToConsole("Webcam IMG stream triggered same URL: " +streamURL + "/"+imgsrc.attr('src'));\u000a                        }\u000a                    }\u000a                });\u000a                $('body').data("webcamSubscribed",subs);\u000a            }\u000a\u000a\u000a            // Webcam loader\u000a            var webcamLoader = function(targetStreamURL){\u000a                self.logToConsole("webcamLoader init");\u000a                $('#IUCWebcamContainerInner img').off('error').on('error',function(){\u000a                    // Error loading\u000a                    $('#webcam_image').data("isLoaded",false);\u000a                    $('#IUCWebcamContainerInner').hide();\u000a                    $('.UICWebCamClick').hide();\u000a                    $('#IUCWebcamContainer div.nowebcam').remove();\u000a                    $('#IUCWebcamContainer > div').append($('<div class="nowebcam text-center"><i class="fas fa-exclamation"></i> Error loading webcam</div>').off('click.UICWebCamErrror').on('click.UICWebCamErrror',function(){\u000a                        $('#control_link a').trigger('click');\u000a                    }));\u000a                }).off('load').on('load',function(){\u000a                    // Loaded okay\u000a                    if ($(this).attr('src').indexOf(targetStreamURL) == 0){\u000a                        self.logToConsole("IUCWebcamContainerInner img loaded ok");\u000a                        // Turn off load due to it being a webcam stream firring multiple times\u000a                        $(this).off('load');\u000a                        // Loaded\u000a                        $('.UICWebCamClick').show();\u000a                        $('#IUCWebcamContainerInner').show();\u000a                        $('#IUCWebcamContainerInner img').show();\u000a                        $('#IUCWebcamContainer div.nowebcam').hide();\u000a                    }\u000a                });\u000a            };\u000a\u000a            // Visibilty handler custom\u000a            // https://developer.mozilla.org/en-US/docs/Web/API/Page_Visibility_API\u000a            var hidden, visibilityChange;\u000a            if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support\u000a                hidden = "hidden";\u000a                visibilityChange = "visibilitychange";\u000a            } else if (typeof document.msHidden !== "undefined") {\u000a                hidden = "msHidden";\u000a                visibilityChange = "msvisibilitychange";\u000a            } else if (typeof document.webkitHidden !== "undefined") {\u000a                hidden = "webkitHidden";\u000a                visibilityChange = "webkitvisibilitychange";\u000a            }\u000a\u000a            // Event handler for visibility\u000a            var eventVIS = function(){\u000a                // If not shown then dont do\u000a                if (!$('#UICWebCamWidget').length){\u000a                    self.logToConsole("WebCam widget not active");\u000a                    return true;\u000a                }\u000a                var hlsCam = false;\u000a                var streamURL = self.settings.webcam_streamUrl();\u000a                if (/.m3u8/i.test(streamURL)){\u000a                    hlsCam = true;\u000a                }\u000a                // What to do\u000a                if (document[hidden]) {\u000a                    self.logToConsole("Visibility changed to hidden");\u000a                    $('#IUCWebcamContainer').data('pausedByVis',true);\u000a                    if (hlsCam){\u000a                        $('#IUCWebcamContainer video')[0].pause();\u000a                    }else{\u000a                        // Hide the cam widget\u000a                        $('#IUCWebcamContainer').hide();\u000a                        $('#IUCWebcamContainerInner img').attr('src','data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7');\u000a                    }\u000a                }else{\u000a                    self.logToConsole("Visibility changed to visible");\u000a                    $('#IUCWebcamContainer').data('pausedByVis',false);\u000a                    if (hlsCam){\u000a                        $('#IUCWebcamContainer video')[0].play();\u000a                    }else{\u000a                        // Reload the webcam\u000a                        $('.UICWebCamClick').hide();\u000a                        $('#IUCWebcamContainer div.nowebcam').remove();\u000a                        $('#IUCWebcamContainer > div').append('<div class="nowebcam text-center"><i class="fas fa-spinner fa-spin"></i> <span class="UIC-pulsate">Loading webcam&hellip;</span></div>');\u000a                        $('#IUCWebcamContainerInner').hide();\u000a                        $('#IUCWebcamContainer').show();\u000a                        // Reinit the loader\u000a                        webcamLoader(streamURL);\u000a                        $('#IUCWebcamContainerInner img').attr('src',streamURL);\u000a                    }\u000a                }\u000a            }\u000a\u000a            // Do we have the visibility handler?\u000a            if (typeof document.addEventListener === "undefined" || hidden === undefined) {\u000a                self.logToConsole("NO event handler for visibility :( ");\u000a            } else if($(document).data('IUCEventVis') != true){\u000a                // Handle page visibility change\u000a                $(document).data('IUCEventVis',true);\u000a                document.addEventListener(visibilityChange, eventVIS, false);\u000a            }\u000a\u000a            // Set loading\u000a            $('.UICWebCamClick').hide();\u000a            $('#IUCWebcamContainer > div').append('<div class="nowebcam text-center"><i class="fas fa-spinner fa-spin"></i> <span class="UIC-pulsate">Loading webcam&hellip;</span></div>');\u000a\u000a            // HLS cam handling is a bit easier than normal stuff\u000a            if(hlsCam){\u000a                // reset\u000a                OctoPrint.coreui.viewmodels.controlViewModel.onWebcamLoaded = self.onWebCamOrg;\u000a                // Clone it\u000a                var clone = $('#webcam_hls').clone();\u000a                clone.removeAttr('id').removeAttr('data-bind');\u000a                $('#IUCWebcamContainer > div').html(clone).find('*').removeAttr('id').removeAttr('data-bind');\u000a\u000a                // Event handling on the main player\u000a                $('#IUCWebcamContainer video').off('error').on('error',function(event){\u000a                    self.logToConsole("webcam_hls HLS error");\u000a                    $('#IUCWebcamContainer video').data('playing',false);\u000a\u000a                    // Error loading sign and show info\u000a                    $('#IUCWebcamContainer video').hide();\u000a                    $('.UICWebCamClick').hide();\u000a                    $('#IUCWebcamContainer div.nowebcam').remove();\u000a                    $('#IUCWebcamContainer > div').append($('<div class="nowebcam text-center"><i class="fas fa-exclamation"></i> Error loading webcam</div>').off('click.UICWebCamErrror').on('click.UICWebCamErrror',function(){\u000a                        $('#control_link a').trigger('click');\u000a                    }));\u000a\u000a                }).off('playing').on('playing',function(event){\u000a                    // Clean up and show the player again\u000a                    $('#IUCWebcamContainer div.nowebcam').remove();\u000a                    $('#IUCWebcamContainer video').show();\u000a                    $('.UICWebCamClick').show();\u000a\u000a                    // Foobar trigger - then just skip if nothing new\u000a                    if (!$('#IUCWebcamContainer div.nowebcam').length && self.settings.webcam_streamUrl() == $('#IUCWebcamContainer video').data('streamURL') && $('#IUCWebcamContainer video').data('playing') === true){\u000a                        self.logToConsole("Webcam HLS playing not updated!");\u000a                        return false;\u000a                    }\u000a                    self.logToConsole("Webcam HLS playing");\u000a\u000a                    // Play HLS and store URL + state\u000a                    var streamURL = self.settings.webcam_streamUrl();\u000a                    $('#IUCWebcamContainer video').data('streamURL',streamURL);\u000a                    $('#IUCWebcamContainer video').data('playing',true);\u000a\u000a                    // Start HLS player - a seperate stream is better - tried canvas copy etc.\u000a                    var video = $('#IUCWebcamContainer video')[0];\u000a                    self.startHLSstream(video,streamURL);\u000a                });\u000a\u000a                // Error handling on webcam handler\u000a                OctoPrint.coreui.viewmodels.controlViewModel.onWebcamErrored = (function(old) {\u000a                    function extendCam(){\u000a                        self.onWebCamErrorOrg();\u000a                        self.logToConsole("Webcam HLS onWebcamErrored triggered");\u000a                        if ($('#IUCWebcamContainer video')[0].paused && $('#IUCWebcamContainer').data('pausedByVis') !== true){\u000a                            // Error loading sign and show info\u000a                            $('#IUCWebcamContainer video').hide();\u000a                            $('#IUCWebcamContainer div.nowebcam').remove();\u000a                            $('#IUCWebcamContainer > div').append($('<div class="nowebcam text-center"><i class="fas fa-exclamation"></i> Error loading webcam</div>').off('click.UICWebCamErrror').on('click.UICWebCamErrror',function(){\u000a                                $('#control_link a').trigger('click');\u000a                            }));\u000a                        }else{\u000a                            $('#IUCWebcamContainer video').show();\u000a                            $('#IUCWebcamContainer div.nowebcam').remove();\u000a                        }\u000a                    }\u000a                    return extendCam;\u000a                })();\u000a\u000a            }else{\u000a                $('#webcam_hls_container').hide();\u000a                // Pause if present\u000a                if ($('#webcam_hls video').length){\u000a                    $('#webcam_hls video')[0].pause();\u000a                }\u000a                $('#UICWebCamWidget').addClass('UICWebcam');\u000a\u000a                // Remove old just in case\u000a                OctoPrint.coreui.viewmodels.controlViewModel.onWebcamErrored = self.onWebCamErrorOrg;\u000a\u000a                // Normal webcam stream\u000a                self.logToConsole("WebCam NON-hls starting");\u000a\u000a                // Clone and cleanup\u000a                var clone = $('#webcam_rotator').clone();\u000a                clone.find('>div:not(:first-child)').remove();\u000a                // Avoid any children added\u000a                clone.find('>div:not(:first-child)').remove();\u000a                $('#IUCWebcamContainer > div').append(clone).find('*').removeAttr('id').removeAttr('data-bind');\u000a                clone.attr('id',"IUCWebcamContainerInner").hide();\u000a\u000a                // init the handler\u000a                webcamLoader(streamURL);\u000a\u000a                // Event handlers\u000a                OctoPrint.coreui.viewmodels.controlViewModel.onWebcamLoaded = (function(old) {\u000a                    function extendWebCam() {\u000a                        self.onWebCamOrg();\u000a                        if ($('#IUCWebcamContainer:visible').length && $('#webcam_image').data("isHidden") !== true){\u000a                            if (OctoPrint.coreui.viewmodels.controlViewModel.webcamLoaded() && $('#webcam_image').data("isLoaded")){\u000a                                self.logToConsole("extendWebCam skipped");\u000a                                return true;\u000a                            }\u000a                            self.logToConsole("extendWebCam called");\u000a                            // Remove the no webcam container\u000a                            $('#IUCWebcamContainer div.nowebcam').remove();\u000a                            $('.UICWebCamClick').show();\u000a                            $('#IUCWebcamContainerInner img').show();\u000a                            var clone = $('#webcam_rotator').clone();\u000a                            clone.find('>div:not(:first-child)').remove();\u000a                            // Compare content of the containers\u000a                            if ($('#IUCWebcamContainerInner').clone().wrap('<p/>').parent().find('*').removeAttr('id').removeAttr('src').html().replace(' style=""' ,'').trim() != clone.wrap('<p/>').parent().find('*').removeAttr('id').removeAttr('data-bind').removeAttr('src').html().replace(' style=""','').trim()){\u000a                                self.logToConsole("WebCam updated TOTAL");\u000a                                $('#IUCWebcamContainerInner').remove();\u000a                                $('#IUCWebcamContainer > div').append(clone).find('*').removeAttr('id');\u000a                                clone.attr('id',"IUCWebcamContainerInner");\u000a                                // Setup error handling again\u000a                                webcamLoader(streamURL);\u000a\u000a                                // Fix the fullscreen overlay if present\u000a                                if ($('#UICWebCamFullInnerDIV').length){\u000a                                    clone.attr('id','UICWebCamFullInnerDIV');\u000a                                    $('#UICWebCamFullInnerDIV').html(clone).find('*').removeAttr('id');\u000a                                    $('#UICWebCamFull img').off('load').on('load',function(){\u000a                                        $('#UICWebCamFull div.nowebcam').remove();\u000a                                    });\u000a                                    $('#UICWebCamFull img').attr('src',streamURL);\u000a                                }\u000a\u000a                            }else if($('#IUCWebcamContainerInner img').attr('src') != streamURL){\u000a                                self.logToConsole("WebCam updated SRC");\u000a                                $('#IUCWebcamContainerInner img').attr('src',streamURL);\u000a                            }\u000a                            // Make sure its shown\u000a                            $('#IUCWebcamContainer > div >div').show();\u000a                            $('#webcam_image').data("isLoaded",true);\u000a                        }\u000a                    }\u000a                    return extendWebCam;\u000a                })();\u000a\u000a                // Set url if not found or not the same\u000a                if ($('#IUCWebcamContainerInner img').attr('src') == undefined || $('#IUCWebcamContainerInner img').attr('src').indexOf(streamURL) == -1){\u000a                    if (streamURL[streamURL.length-1] == "?"){\u000a                        streamURL += "&"\u000a                    }else{\u000a                        streamURL += "?"\u000a                    }\u000a                    streamURL += new Date().getTime();\u000a                    self.logToConsole("Setting webcam url:"+ streamURL);\u000a                    $('#IUCWebcamContainerInner img').attr('src',streamURL);\u000a                    // Fix the fullscreen overlay if present\u000a                    if ($('#UICWebCamFull img').length){\u000a                        $('#UICWebCamFull img').attr('src',streamURL);\u000a                    }\u000a                }\u000a\u000a                // Fix the fullscreen overlay if present\u000a                if ($('#UICWebCamFullInnerDIV').length){\u000a                    var clone = $('#webcam_rotator').clone();\u000a                    clone.find('>div:not(:first-child)').remove();\u000a                    clone.attr('id','UICWebCamFullInnerDIV');\u000a                    $('#UICWebCamFullInnerDIV').html(clone).find('*').removeAttr('id').removeAttr('data-bind');\u000a                    $('#UICWebCamFull img').off('load').on('load',function(){\u000a                        $('#UICWebCamFull div.nowebcam').remove();\u000a                    });\u000a                    $('#UICWebCamFull img').attr('src',streamURL);\u000a                }\u000a            }\u000a\u000a            // Hack the webcam start flow\u000a            var prevVal = OctoPrint.coreui.browserTabVisible;\u000a            OctoPrint.coreui.browserTabVisible = true;\u000a            var prevVal2 = OctoPrint.coreui.selectedTab;\u000a            OctoPrint.coreui.selectedTab = '#control'\u000a            // Trigger change\u000a            OctoPrint.coreui.onTabChange('#control');\u000a            // Restore\u000a            OctoPrint.coreui.browserTabVisible = prevVal;\u000a            OctoPrint.coreui.selectedTab = prevVal2;\u000a\u000a            // Start the HLS cam just to make sure\u000a            if (hlsCam){\u000a                // Play HLS and store URL + state\u000a                var streamURL = self.settings.webcam_streamUrl();\u000a                $('#IUCWebcamContainer video').data('streamURL',streamURL);\u000a                $('#IUCWebcamContainer').data('pausedByVis',true);\u000a                $('#IUCWebcamContainer video').data('playing',true);\u000a\u000a                // Start HLS player - a seperate stream is better - tried canvas copy etc.\u000a                var video = $('#IUCWebcamContainer video')[0];\u000a                self.startHLSstream(video,streamURL);\u000a            }\u000a\u000a            // Fix zoom overlay\u000a            self.set_addWebCamZoom(self.settings.settings.plugins.uicustomizer.addWebCamZoom());\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Set compact drop down menu\u000a        self.set_compactMenu= function(enabled){\u000a            if (enabled){\u000a                $('div.UICMainMenu').addClass('UICCompactMenu');\u000a            }else{\u000a                $('div.UICMainMenu').removeClass('UICCompactMenu');\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Fix modal\u000a        self.fixSettingsModal = function(eventType){\u000a            // Nothing to do\u000a            if (!$('body').hasClass('UICResponsiveMode')){\u000a                return true;\u000a            }\u000a\u000a            self.logToConsole('FixSettingsModal triggered : ' + eventType);\u000a\u000a            // Fix modal sizing\u000a            if ($('#settings_dialog:visible').length && $('#settings_dialog:visible').attr('style') != undefined && $('#settings_dialog:visible').attr('style').match(/(^|\u005cs)max-height: \u005cd+px !important/i) == null){\u000a                var newstyle = $('#settings_dialog div.modal-body:first').attr('style').replace(/(^|\u005cs)max-height: \u005cd+px/i,`$& !important`);\u000a                // Quick and dirty\u000a                newstyle = newstyle.replace("!important !important","!important");\u000a                $('#settings_dialog div.modal-body:first').attr('style',newstyle);\u000a            }\u000a\u000a            // Fix settingslists\u000a            if ($('div.modal-body:visible').length){\u000a                var setfixheight = $('#settings_dialog div.modal-body:first').height();\u000a                $('#settings_plugin_pluginmanager_pluginlist').height(setfixheight-300);\u000a                $('#settings_plugin_softwareupdate_updatelist').height(setfixheight-300);\u000a            }\u000a\u000a            // Fix collapse menu hack for smaller screens than normal bootstrap 2 :(  All these hacks are terrible i know but fun to make - Maybe I should have spent my time making a implementation using BootStap4 instead - well...\u000a            if ($('#settings_dialog_menu:visible').length && $('#UICsettingsMenu').length){\u000a\u000a                // Set width\u000a                $('#UICsettingsMenuNav').width($('#UICFullSettingsBox').width());\u000a                var curClass = $('#settings_dialog_menu').attr('class');\u000a                // turn on/off collapse\u000a                if ($('#UICsettingsMenuNav div.container:first').width() < $('#UICsettingsMenu').data('UICOrgWidth')){\u000a                    if (!$('#settings_dialog_menu').hasClass('UICHackResponseActive')){\u000a                        curClass = curClass.replace(/-UICHackResponse/g,"") + " UICHackResponseActive";\u000a                        $('#settings_dialog_menu').attr('class',curClass);\u000a                        $('#UICsettingsMenuNav a.btn-navbar').show();\u000a                        $('#UICsetMenuShow').show();\u000a                        $('#UICsettingsMenu li.dropdown.open').removeClass('open');\u000a                    }\u000a                }else if($('#settings_dialog_menu').hasClass('UICHackResponseActive')){\u000a                    curClass = curClass.replace(/collapse/g,"collapse-UICHackResponse").replace("UICHackResponseActive","");\u000a                    $('#settings_dialog_menu').attr('class',curClass);\u000a                    $('#UICsettingsMenuNav a.btn-navbar').removeClass('collapsed').hide();\u000a                    $('#settings_dialog_menu').removeClass('in').css('height',0);\u000a                    $('#UICsetMenuShow').hide();\u000a                    $('#UICsettingsMenu li.dropdown.open').removeClass('open');\u000a                }\u000a            }\u000a\u000a            // Fix for the dropdown menu\u000a            // how much space do we have\u000a            var screenroom = $(window).height()-($('#UICsettingsMenuNav').offset().top+70);\u000a            // Menu item length\u000a            var menuih = $('#settings_dialog_menu li.dropdown').first().outerHeight()+3;\u000a            // Calc each length\u000a            var mlength = menuih*$('#settings_dialog_menu li.dropdown').length;\u000a            var smallscreen = false;\u000a            if (mlength <= screenroom){\u000a                // Should the main menu have overflow\u000a                $('#settings_dialog_menu li.dropdown').each(function(idx,val){\u000a                    var thislen = ($(this).find('li').length*menuih)+((idx+1)*menuih);\u000a                    if (thislen > screenroom){\u000a                        smallscreen = true;\u000a                        return false;\u000a                    }\u000a                })\u000a            }else{\u000a                smallscreen = true;\u000a            }\u000a\u000a            // Fix or not\u000a            if (smallscreen){\u000a                // Different menu types - different layout\u000a                if ($('#settings_dialog_menu').hasClass('nav-collapse')){\u000a                    $('#UICsettingsMenu , #UICsettingsMenu ul').addClass('UICscrollMenu').scrollTop(0);\u000a                    $('#UICsettingsMenu').css('max-height',screenroom+"px");\u000a                    $('#UICsettingsMenu ul').css('max-height','');\u000a                }else{\u000a                    $('#UICsettingsMenu ul').addClass('UICscrollMenu').scrollTop(0);\u000a                    $('#UICsettingsMenu').removeClass('UICscrollMenu');\u000a                    $('#UICsettingsMenu').css('max-height','');\u000a                    $('#UICsettingsMenu ul').css('max-height',screenroom+"px");\u000a                }\u000a            }else{\u000a                $('#UICsettingsMenu , #UICsettingsMenu ul').removeClass('UICscrollMenu');\u000a                $('#UICsettingsMenu').css('max-height','none');\u000a            }\u000a        }\u000a\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Set responsive\u000a        self.set_responsiveMode = function(enabled){\u000a            if (enabled){\u000a                $('.UICMainMenu').addClass('nav-collapse')\u000a                // Skip if active\u000a                if ($('body').hasClass('UICResponsiveMode')){\u000a                    return true;\u000a                }\u000a\u000a                // Add dynamic viewport\u000a                $('head').append('<meta id="UICViewport" name="viewport" content="width=device-width, initial-scale=1.0">');\u000a\u000a                // Check for touch\u000a                if (typeof Modernizr !== 'undefined' && Modernizr.touchevents) {\u000a                    $('body').addClass('UICTouchDevice');\u000a                }\u000a\u000a                // Fix gcode\u000a                $('#gcode div.tooltip.right').removeClass('right').addClass('left UICToolTipLeft');\u000a\u000a                // Build settings hack --------------------------------------------------------- START\u000a                // Fix an id\u000a                $('#settings_dialog > div.modal-body > div.full-sized-box:first').attr('id','UICFullSettingsBox');\u000a\u000a                // Make container for top menu layout\u000a                $('#UICFullSettingsBox').prepend('\u005c\u000a                <div class="navbar navbar-static" id="UICsettingsMenuNav">\u005c\u000a                    <div class="navbar-inner">\u005c\u000a                        <div class="container">\u005c\u000a                            <span class="brand" id="UICsetMenuShow"></span>\u005c\u000a                            <a class="btn btn-navbar" data-target=".UICsettingsNewMenu" data-toggle="collapse"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></a>\u005c\u000a                            <div class="nav-collapse-UICHackResponse collapse-UICHackResponse UICsettingsNewMenu pull-left">\u005c\u000a                                <ul class="nav" id="UICsettingsMenu"></ul>\u005c\u000a                            </div>\u005c\u000a                        </div>\u005c\u000a                    </div>\u005c\u000a                </div>');\u000a\u000a                // Convert the existing to the other format\u000a                var menuitem = null;\u000a                var menuItems = null;\u000a                var curactive = null;\u000a                $('#settings_dialog_menu ul li').each(function(){\u000a                    if ($(this).hasClass('nav-header')){\u000a                        if (menuitem != null){\u000a                            menuitem.append(menuItems);\u000a                            $('#UICsettingsMenu').append(menuitem);\u000a                        }\u000a                        menuitem = $('<li class="dropdown"><a class="dropdown-toggle" role="button" data-toggle="dropdown" href="#">'+$(this).text()+' <b class="caret"></b></a></lI>');\u000a                        menuItems = $('<ul class="dropdown-menu" role="menu"></ul>');\u000a                    }else{\u000a                        if ($(this).hasClass('active')){\u000a                            curactive = $(this);\u000a                            $(this).removeClass('active');\u000a                        }\u000a                        menuItems.append($(this));\u000a                    }\u000a                });\u000a                // Append the last item\u000a                if (menuitem != null){\u000a                    menuitem.append(menuItems);\u000a                    $('#UICsettingsMenu').append(menuitem);\u000a                }\u000a                // Remove it all\u000a                $('#settingsTabs').html('');\u000a                // Insert menu\u000a                $('#settings_dialog_content').insertAfter($('#UICsettingsMenuNav')).removeClass('scrollable');\u000a                // Hide the container fpr the old menu\u000a                $('#settings_dialog_menu').parent().hide();\u000a                // Remove the id and move it to the new one\u000a                $('#settings_dialog_menu').removeAttr('id').addClass('UICsettingsMenuOldMenu');\u000a                $('#UICsettingsMenuNav div.UICsettingsNewMenu').attr('id','settings_dialog_menu');\u000a                // For restoring\u000a                $('#settingsTabs').addClass('UICsettingsMOldTabs');\u000a                $('#UICsettingsNewMenu').attr('id','settingsTabs');;\u000a\u000a                // hide the "collapse/responsive" stuff\u000a                $('#UICsettingsMenuNav a.btn-navbar').hide();\u000a                $('#UICsetMenuShow').hide();\u000a\u000a                $('#settings_dialog_label').prepend('<span class="hidden-phone pull-right" id="UICSettingsHeader"></span>');\u000a\u000a                // Close menu on click if open and set item title\u000a                $('#settings_dialog_menu a:not(.dropdown-toggle)').off('click.UICSetMenu').on('click.UICSetMenu',function(){\u000a                    $('#settings_dialog div.modal-body:first').scrollTop(0);\u000a                    if ($('#settings_dialog_menu').hasClass('in')){\u000a                        $('#UICsettingsMenuNav a.btn-navbar').trigger('click');\u000a                    }\u000a                    var settingsMenuTxt = $(this).closest('li.dropdown').find('a:first').text() + '&nbsp;<i class="fas fa-chevron-right"></i>&nbsp;'+$(this).text();\u000a                    $('#UICsetMenuShow').html(settingsMenuTxt);\u000a                    $('#UICSettingsHeader').html(settingsMenuTxt);\u000a                });\u000a\u000a                // Click the active menu to make it all look goode\u000a                if (curactive != null){\u000a                    curactive.find('a:first').trigger('click');\u000a                }\u000a\u000a                // Fix floating errors\u000a                $('#UICFullSettingsBox div.control-group:not(.row-fluid)').addClass('row-fluid UICRemoveFluidRow');\u000a\u000a                $('#settings_dialog_content').addClass('span12').removeClass('span9');\u000a\u000a                // Fix buttons footer\u000a                $('#settings_dialog > div.modal-footer button:has(i)').not('.btn-primary').each(function(){$(this).contents().eq(1).wrap('<span class="hidden-phone"/>')});\u000a\u000a                // Build settings hack --------------------------------------------------------- END\u000a\u000a                // Fix modals on show\u000a                $('body').on('shown.bs.modal.UICHandler','#settings_dialog', function(event) {\u000a                    if ($('body').hasClass('UICResponsiveMode') && $('#settings_dialog_menu:visible').length ){\u000a                        // Save size for mobile resizing for settings\u000a                        if ($('#settings_dialog_menu:visible').length && $('#UICsettingsMenu').data('UICOrgWidth') == undefined || $('#UICsettingsMenu').data('UICOrgWidth') == 0){\u000a                            $('#settings_dialog_menu').width('2000px');\u000a                            $('#UICsettingsMenu').data('UICOrgWidth',$('#UICsettingsMenu').width()+20);\u000a                            $('#settings_dialog_menu').width('');\u000a                             // Hack on modal heights\u000a                            self.fixSettingsModal('resize');\u000a                        }else{\u000a                            // Hack on modal heights\u000a                            self.fixSettingsModal('shown');\u000a                        }\u000a                    }\u000a                });\u000a\u000a                // Fix resizing of modals\u000a                $(window).off('resize.UICHandler').on('resize.UICHandler',function(){\u000a                    if (self.modalTimer != null){\u000a                        window.clearTimeout(self.modalTimer);\u000a                    }\u000a                    self.modalTimer = setTimeout(function(){self.fixSettingsModal('resize')}, 100);\u000a                });\u000a\u000a                // Add menu button to the main menu\u000a                $('#navbar > div.navbar-inner > div:first').prepend('<a class="btn btn-navbar collapsed" data-toggle="collapse" data-target=".UICMainMenu"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></a>');\u000a\u000a                // Close menu on click\u000a                $('div.UICMainMenu a:not(.dropdown-toggle)').off('click.UICMainMenu').on('click.UICMainMenu',function(){\u000a                    if ($('div.UICMainMenu').hasClass('in')){\u000a                        $('#navbar div.navbar-inner a.btn-navbar').trigger('click');\u000a                    }\u000a                });\u000a\u000a\u000a                // Add title to menu items\u000a                $('div.UICMainMenu > ul.nav > li:not([id^="navbar_plugin"]) > a,li.UICExcludeFromTopIcons > a').each(function(){\u000a                    var title= $(this).attr('title');\u000a                    if (title != undefined){\u000a                        $(this).append('<span class="UICHideDesktop">'+title+'</span>');\u000a                    }\u000a                });\u000a\u000a                $('body').addClass('UICResponsiveMode');\u000a\u000a                // Trigger any open menu\u000a                if ($('#settings_dialog_menu:visible').length){\u000a                    $('#settings_dialog_menu').width('2000px');\u000a                    $('#UICsettingsMenu').data('UICOrgWidth',$('#UICsettingsMenu').width()+20);\u000a                    $('#settings_dialog_menu').width('');\u000a                    $(window).trigger('resize.UICHandler');\u000a                }\u000a\u000a                // Fix labels on buttons\u000a                $('div.UICMainCont .btn > i.fa,div.UICMainCont .btn > i.fas').each(function(){\u000a                    if ($(this).next().prop("tagName") == "SPAN" && $(this).next().text() != ""){\u000a                        $(this).next().addClass('hidden-tablet UICHideTablet');\u000a                    }\u000a                    if ($(this).prev().prop("tagName") == "SPAN" && $(this).prev().text() != ""){\u000a                        $(this).prev().addClass('hidden-tablet UICHideTablet');\u000a                    }\u000a                    if (!$(this).next().length){\u000a                        var parent = $(this).parent();\u000a                        if (parent.text() != undefined && $.trim(parent.text()) != "" && !parent.find('span').length){\u000a                            var texitem = parent.contents().filter(function() {\u000a                                return this.nodeType == 3 && $.trim(this.textContent) != '';\u000a                            });\u000a                            var textval = texitem.text();\u000a                            texitem.remove();\u000a                            parent.append('<span class="hidden-tablet">'+textval+'</span>');\u000a                            if ($(this).parent().prop('title') == ""){\u000a                                $(this).parent().prop('title',textval);\u000a                            }\u000a                        }\u000a                    }\u000a                });\u000a\u000a                // Hack this special button\u000a                $('#job_pause span:not(.hidden-tablet.UICHideTablet)').addClass('hidden-tablet UICHideTablet');\u000a\u000a            }else{\u000a                // Allow full menu when not responsive\u000a                $('.UICMainMenu').removeClass('nav-collapse');\u000a                if (!$('body').hasClass('UICResponsiveMode')){\u000a                    return true;\u000a                }\u000a                // Remove meta viewport\u000a                $('#UICViewport').remove();\u000a                $('.UICHideTablet').removeClass('UICHideTablet hidden-tablet');\u000a                $('body').removeClass('UICTouchDevice');\u000a\u000a                // Remmove events\u000a                $('body').off('shown.bs.modal.UICHandler');\u000a                $(window).off('resize.UICHandler');\u000a                // Remove fluid hack\u000a                $('#UICFullSettingsBox div.control-group.UICRemoveFluidRow').removeClass('row-fluid UICRemoveFluidRow');\u000a\u000a                // Clean menu height hacks\u000a                $('#UICsettingsMenu .pre-scrollable').removeClass('pre-scrollable');\u000a                $('#UICsettingsMenu .dropdown-menu').css({'height':''});\u000a\u000a                // revert settings menu\u000a                $('#UICSettingsHeader').remove();\u000a                $('#settingsTabs').removeAttr('id');\u000a                $('ul.UICsettingsMOldTabs').attr('id','settingsTabs').removeClass('UICsettingsMOldTabs');\u000a                $('#settings_dialog_menu').removeAttr('id');\u000a                $('div.UICsettingsMenuOldMenu').attr('id','settings_dialog_menu').removeClass('UICsettingsMenuOldMenu');\u000a                $('#UICsettingsMenu li ').each(function(){\u000a                   if ($(this).hasClass('dropdown')){\u000a                        $('#settingsTabs').append($('<li class="nav-header">'+$(this).find('a:first').text()+'</li>'));\u000a                   }else{\u000a                        $('#settingsTabs').append($(this));\u000a                   }\u000a                });\u000a                $('#settings_dialog_content').addClass('span9').removeClass('span12');\u000a                $('#settings_dialog > div.modal-footer span.hidden-phone').each(function(){$(this).parent().append($(this).text());$(this).remove();})\u000a\u000a                $('#settings_dialog_content').insertAfter($('#settings_dialog_menu'));\u000a                $('#settings_dialog_content').addClass('scrollable');\u000a                $('#settings_dialog_menu').parent().show();\u000a                $('#settings_dialog_menu a:not(.dropdown-toggle)').off('click.UICSetMenu');\u000a                $('#UICsettingsMenuNav').remove();\u000a                $('#UICFullSettingsBox').removeAttr('id');\u000a\u000a\u000a                // Remove menu hacks\u000a                $('#navbar div.navbar-inner a.btn-navbar').remove();\u000a                $('div.UICMainMenu .UICHideDesktop').remove();\u000a\u000a                $('.UICToolTipLeft').removeClass('UICToolTipLeft');\u000a\u000a\u000a                $('body').removeClass('UICResponsiveMode');\u000a\u000a\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Should we center the icons or not?\u000a        self.set_centerTopIcons = function(enabled){\u000a            // Remove it not request and not running responsive\u000a            if ((!enabled && !$('body').hasClass('UICResponsiveMode')) && $('ul.UICHeaderIcons').length){\u000a                $('div.UICMainMenu > ul.nav').prepend($('ul.UICHeaderIcons > li'));\u000a                $('ul.UICHeaderIcons').remove();\u000a                return true;\u000a            }\u000a            // Build header icons always to fix responsive or on request\u000a            if ((enabled || $('body').hasClass('UICResponsiveMode')) && !$('ul.UICHeaderIcons').length){\u000a                // Move header icons out of menu\u000a                $('div.UICMainMenu').after($('<ul class="UICHeaderIcons nav"></ul>').append($('div.UICMainMenu ul.nav > li[id^="navbar_plugin"]:not(.UICExcludeFromTopIcons)')));\u000a            }\u000a            if (enabled){\u000a                $('ul.UICHeaderIcons').addClass('CenterMe');\u000a            }else{\u000a                $('ul.UICHeaderIcons').removeClass('CenterMe');\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Set fixed header on/off\u000a        self.set_fixedHeader = function(enabled){\u000a            if (enabled){\u000a                $('body').addClass('UICfixedHeader');\u000a                $('#navbar').removeClass('navbar-static-top').addClass('navbar-fixed-top')\u000a                $('#navbar').css('overflow','visible');\u000a            }else{\u000a                $('body').removeClass('UICfixedHeader');\u000a                $('#navbar').addClass('navbar-static-top').removeClass('navbar-fixed-top');\u000a                $('#navbar').css('overflow','');\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Set Compact icons\u000a        self.set_navbarplugintempfix = function(enabled){\u000a            if (!$('#navbar_plugin_navbartemp').length){\u000a                return true;\u000a            }\u000a            if (enabled){\u000a                OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.navbartemp.useShortNames(true);\u000a                OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.navbartemp.makeMoreRoom(true);\u000a                $('#navbar_plugin_navbartemp').addClass('UICIconHack');\u000a            }else{\u000a                $('#navbar_plugin_navbartemp').removeClass('UICIconHack');\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Set fixed footer on/off\u000a        self.set_fixedFooter = function(enabled){\u000a            if (enabled){\u000a                // Skip if active\u000a                if ($('body').hasClass('UICfixedFooter')){\u000a                    return true;\u000a                }\u000a                $('body').addClass('UICfixedFooter');\u000a                $('div.footer').addClass('navbar navbar-fixed-bottom');\u000a                $('div.footer').append($('<div class="navbar-inner"></div>'));\u000a                $('div.footer >ul').appendTo('div.footer > div.navbar-inner');\u000a                $('#footer_links').addClass('nav');\u000a                $('#footer_version').addClass('brand nav');\u000a                $("div.octoprint-container" ).after( $('div.footer'));\u000a            }else{\u000a                // Skip if not active\u000a                if (!$('body').hasClass('UICfixedFooter')){\u000a                    return true;\u000a                }\u000a                $('body').removeClass('UICfixedFooter');\u000a                $('div.footer').removeClass('navbar navbar-fixed-bottom');\u000a                $('div.footer > div.navbar-inner > ul').appendTo('div.footer');\u000a                $('div.footer > div.navbar-inner').remove();\u000a                $('#footer_links').removeClass('nav');\u000a                $('#footer_version').removeClass('brand nav');\u000a                $("div.octoprint-container" ).append( $('div.footer'));\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Set graph background\u000a        self.set_hideGraphBackground = function(enabled){\u000a            if (enabled){\u000a                $('#temperature-graph').addClass('UICnoBackground');\u000a            }else{\u000a                $('#temperature-graph').removeClass('UICnoBackground');\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Fix fluid layout\u000a        self.set_fluidLayout = function(enabled){\u000a            if (enabled){\u000a                $('#navbar > div.navbar-inner > div:first').removeClass("container").addClass("container-fluid").removeAttr("style","");\u000a                $('div.UICMainCont').removeClass("container").addClass("container-fluid");\u000a                $('div.UICMainCont > div.row:first').removeClass("row").addClass("row-fluid");\u000a            }else{\u000a                $('#navbar > div.navbar-inner > div:first').removeClass("container-fluid").addClass("container");\u000a                $('div.UICMainCont').removeClass("container-fluid").addClass("container");\u000a                $('div.UICMainCont > div.row-fluid:first ').removeClass("row-fluid").addClass("row");\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Improve the HLS playback method\u000a        self.startHLSstream = function(element,streamURL){\u000a            if (element.canPlayType('application/vnd.apple.mpegurl')) {\u000a                self.logToConsole("HLS Playing APPLE style : " + streamURL);\u000a                element.src = streamURL;\u000a            }else if (Hls.isSupported()) {\u000a                self.logToConsole("HLS Playing oldschool style : " + streamURL);\u000a                var hls = new Hls();\u000a                hls.loadSource(streamURL);\u000a                hls.attachMedia(element);\u000a                // Play\u000a                hls.on(Hls.Events.MANIFEST_PARSED, function() {\u000a                    element.play();\u000a                });\u000a            }else{\u000a                self.logToConsole("HLS NOT playing ANY style :  " + streamURL);\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Build columns layout and width\u000a        self.buildColumns = function(prefix){\u000a            var prefixItem = '';\u000a            var colsSave = [];\u000a            $('#UICSortCols ul').each(function(key,val){\u000a                colsSave[key] = {};\u000a                $(this).find('li').each(function(key2,val2){\u000a                    if (prefix){\u000a                        if (key2 < 10){\u000a                            prefixItem = '_0'+key2;\u000a                        }else{\u000a                            prefixItem = '_'+key2;\u000a                        }\u000a                    }\u000a                    // Hidden or shown\u000a                    if ($(this).find('input:checkbox').is(":checked")){\u000a                        colsSave[key][prefixItem+$(this).data('id')] = true;\u000a                    }else{\u000a                        colsSave[key][prefixItem+$(this).data('id')] = false;\u000a                    }\u000a                });\u000a            });\u000a            self.logToConsole("Built these cols:"+JSON.stringify(colsSave));\u000a\u000a            var widths = $('#UICSortCols input.uiccolwidth').map(function(){return $(this).val();}).get();\u000a            return [ko.observableArray(colsSave), ko.observableArray(widths)];\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        self.initTabs = function(usageList){\u000a             // Build tabs selectors\u000a            var indexobj = {};\u000a            var listItems = [];\u000a            $(usageList).each(function(idx,val){\u000a                // Append if found only\u000a                if ($('#'+val[0]).length){\u000a                    indexobj[val[0]] = val;\u000a                    // Old data bug\u000a                    // No icon if not found\u000a                    if (indexobj[val[0]][3] == null){\u000a                        indexobj[val[0]][3] = false;\u000a                    }\u000a                    // Default design if not found\u000a                    if (indexobj[val[0]][4] == null){\u000a                        indexobj[val[0]][4] = 'textOnly';\u000a                    }\u000a                    // Default color if not found\u000a                    if (indexobj[val[0]][5] == null){\u000a                        indexobj[val[0]][5] = '#000000';\u000a                    }\u000a                    listItems.push(val[0]);\u000a                }\u000a            });\u000a\u000a            // Store all tabs names and add any unknown\u000a            $('#tabs li:not(.tabdrop) a').each(function(pos,val){\u000a                if ($(this).data('orgPos') == undefined){\u000a                    $(this).data('orgPos',pos);\u000a                }\u000a                if ($(this).data('orgName') == undefined){\u000a                    var name = $.trim($(this).text());\u000a                    $(this).data('orgName',name);\u000a                }\u000a                // Get the parent id\u000a                var parid = $(this).parent().attr('id');\u000a\u000a                // Add any unknown items\u000a                if (!(indexobj.hasOwnProperty(parid))){\u000a                    listItems.push(parid);\u000a                    // Get default icon design\u000a                    var prevIcon = $(this).find('i');\u000a                    var prevIconName = '';\u000a                    if (prevIcon.length){\u000a                        prevIconName = prevIcon.attr('class');\u000a                    }\u000a                    // ID, Shown,Customlabel,icon class string, tab design =(true,false,iconOnly,textOnly), icon color\u000a                    // 0 ,   1  ,    2      ,     3           ,      4                                    ,   5\u000a                    indexobj[parid] = [parid,true,false,prevIconName,'textOnly','#000000'];\u000a                }\u000a            });\u000a            return [indexobj,listItems];\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        self.buildCustomTab = function(data){\u000a            // PARAMS:\u000a            // [parid,true,false,'icon',true/false/textOnly/iconOnly]\u000a            // ID, Shown,Customlabel,tab design:, color code\u000a            // 0 ,   1  ,    2      , 3         , 5\u000a            // Append them\u000a            var val = data[0];\u000a            var target = $('#'+val).find('a');\u000a            var newtabcontent = target.clone();\u000a            var targetID = target.attr('href');\u000a            newtabcontent.find('i').remove();\u000a            // Hide them\u000a            if (data[1]){\u000a                $('#'+val).show();\u000a            }else{\u000a                $('#'+val).hide();\u000a                $(targetID).removeClass('active');\u000a            }\u000a            var title = target.data('orgName');\u000a            // Remove label if icon is present only\u000a            if (data[4] == "iconOnly" && data[3] != ''){\u000a                $(newtabcontent).html('');\u000a            }else{\u000a                if (data[2] != false){\u000a                    title = data[2];\u000a                    $(newtabcontent).html(data[2]);\u000a                }else{\u000a                    $(newtabcontent).html(target.data('orgName'));\u000a                }\u000a            }\u000a            // Set color\u000a            var colorclass = {};\u000a            if (data[5] != undefined && data[5] != false){\u000a                colorclass ={'color':data[5]};\u000a            }\u000a            // On the right or the left hand side icon only\u000a            if (data[4] === true && data[3] != ''){\u000a                $(newtabcontent).prepend($('<i class="UICPadRight hidden-tablet '+data[3]+'"></i>').css(colorclass));\u000a            }else if (data[4] === false && data[3] != ''){\u000a                $(newtabcontent).append($('<i class="UICPadLeft hidden-tablet '+data[3]+'"></i>').css(colorclass));\u000a            }else if (data[4] == "iconOnly" && data[3] != ''){\u000a                $(newtabcontent).append($('<i class="'+data[3]+'"></i>').css(colorclass));\u000a            }\u000a            $(target).html(newtabcontent.html()).attr('title',title);\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        self.buildCustomTabsSave = function(){\u000a            var newData = [];\u000a            $('#settings_uicustomizer_tabs_look div.controls').each(function(){\u000a                var label = $(this).find('input.UICTabNameInput').val();\u000a                if (label == ""){\u000a                    label = false;\u000a                }\u000a                var iconSrc = $(this).find('button.UICTabIcon i');\u000a                if (iconSrc.hasClass('UICIconEmpty')){\u000a                    var classtxt = false;\u000a                }else{\u000a                    var classtxt = $.trim(iconSrc.attr('class'));\u000a                }\u000a                var color = "#000000";\u000a                if (iconSrc.data('color') != undefined){\u000a                    color = iconSrc.data('color');\u000a                }\u000a                newData.push(\u000a                    [\u000a                        $(this).parent().data('tabid'),\u000a                        $(this).find('button.UICTabToggle i').hasClass('fa-eye'),\u000a                        label,\u000a                        classtxt,\u000a                        $(this).find('ul.UICTabDesign li.active a').data('design'),\u000a                        color\u000a                    ]\u000a                );\u000a            });\u000a            return newData;\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Inspired by: https://itsjavi.com/fontawesome-iconpicker/\u000a        self.iconSearchPopover = function(searchNow,callback,addDelete,addColorSelector,startcolor,container,placement){\u000a            if (addDelete === undefined){\u000a                addDelete = true;\u000a            }\u000a            if (addColorSelector === undefined){\u000a                addColorSelector = true;\u000a            }\u000a            // Set blank start color\u000a            if (startcolor === undefined){\u000a                startcolor = false;\u000a            }\u000a            if (container === undefined){\u000a                container = 'body';\u000a            }\u000a            // Set placement\u000a            if (placement === undefined){\u000a                placement = 'left';\u000a            }\u000a            if (typeof searchNow == "string"){\u000a                searchNow = searchNow.replace(/fa-|fas |far |fal |fad |fab |fa /gi,"");\u000a            }\u000a            return {\u000a                'html': true,\u000a                'container': container,\u000a                'placement' : placement,\u000a                'title' : function(){\u000a                    var myself = $(this);\u000a                    // Hack apply class to myself\u000a                    myself.data('popover').$tip.addClass('UICIconPicker');\u000a                    if (myself.data("frun") != true){\u000a                        myself.data("frun",true);\u000a                        return false;\u000a                    }\u000a                    // Lookup dynamic source if possible\u000a                    var defaultstr = searchNow;\u000a                    if (typeof searchNow == "object"){\u000a                        // Dont search empty icons\u000a                        if (searchNow.hasClass('UICIconEmpty')){\u000a                            defaultstr = '';\u000a                        }else{\u000a                            defaultstr = searchNow.attr('class');\u000a                        }\u000a                    }else if (typeof searchNow == "function"){\u000a                        defaultstr = searchNow();\u000a                    }\u000a                    defaultstr = defaultstr.replace(/fa-|fas |far |fal |fad |fab |fa /gi,"");\u000a                    // Convert colors from object or string\u000a                    var strcolor = false;\u000a                    if (typeof startcolor == "object"){\u000a                        if ($(startcolor).data('color') !== undefined){\u000a                            strcolor = $(startcolor).data('color');\u000a                        }else if(typeof $(startcolor).css('color') == "string"){\u000a                            var rgb = $(startcolor).css('color').match(/^rgba?\u005c((\u005cd+),\u005cs*(\u005cd+),\u005cs*(\u005cd+)(?:,\u005cs*(\u005cd+))?\u005c)$/);\u000a                            hexcolor = function(x) {\u000a                                return ("0" + parseInt(x).toString(16)).slice(-2);\u000a                            }\u000a                            strcolor =  "#" + hexcolor(rgb[1]) + hexcolor(rgb[2]) + hexcolor(rgb[3]);\u000a                        }else{\u000a                            strcolor = false\u000a                        }\u000a                    }else{\u000a                        strcolor = startcolor;\u000a                    }\u000a\u000a                    // hide others\u000a                    $('.UICShowIconPicker').not(myself).popover('hide');\u000a                    // Build main forms\u000a                    var searchInput = $('<input type="search" autocomplete="off" class="UICiconSearchFilter form-control" value="'+defaultstr+'" placeholder="Type to search">');\u000a                    var closebtn = $('<button type="button" class="UICiconSearchClose btn btn-mini pull-right"><i class="fas fa-times"></i></button>');\u000a                    // Close\u000a                    closebtn.off('click').on('click',function(){\u000a                        myself.popover('hide');\u000a                    });\u000a\u000a                    // auto search handler\u000a                    searchInput.off('keyup').on('keyup',function(e){\u000a                        e.preventDefault();\u000a                        if (e.key == "Escape") {\u000a                            myself.popover('hide');\u000a                            e.stopPropagation();\u000a                            return false;\u000a                        }\u000a                        $this = $(this);\u000a                        if ($this.data('keyTime') != undefined && $this.data('keyTime') != null){\u000a                            window.clearTimeout($this.data('keyTime'));\u000a                            $this.data('keyTime',null);\u000a                        }\u000a                        // Dont search small string\u000a                        var search = $.trim($this.val());\u000a                        if (search.length <= 2 || $this.data('prevSearch') == search){\u000a                            return true;\u000a                        }\u000a                        var target = searchInput.closest('div.popover').find('div.UICiconSearchResults');\u000a                        target.html('<div class="text-center UICiconSearchInfo"><i class="fas fa-spinner fa-pulse"></i>&nbsp;Searching&hellip;</div>');\u000a\u000a                        // Set a time before searching\u000a                        var timeout = window.setTimeout(function(){\u000a                            if ($this.data('prevAjax') != undefined && $this.data('prevAjax') != null){\u000a                                $this.data('prevAjax').abort();\u000a                            }\u000a                            var xhr = $.ajax({\u000a                                method: "POST",\u000a                                url: "https://api.fontawesome.com",\u000a                                contentType: 'application/json',\u000a                                dataType: 'application/json',\u000a                                headers: {'Accept':'application/json'},\u000a                                data: JSON.stringify({query: "query { search(version: \u005c"5.13.0\u005c", query: \u005c""+search+"\u005c", first: 100) { label id membership{ free } } }"}),\u000a                            }).always(function(data){\u000a                                if (data.status == 200){\u000a                                    try {\u000a                                        var jsonObj = JSON.parse(data.responseText);\u000a                                    }\u000a                                    catch(err) {\u000a                                        target.html('<div class="text-center UICiconSearchInfo"><i class="fas fa-exclamation-circle"></i> Error searching&hellip;<br><code>Error: Bad JSON</code></div>');\u000a                                        return false;\u000a                                    }\u000a                                    $this.data('prevSearch',search);\u000a                                    // Trigger the icon refresher\u000a                                    self._iconSearchBuildResults(jsonObj,target,myself,search,callback);\u000a                                }else{\u000a                                    target.html('<div class="text-center UICiconSearchInfo"><i class="fas fa-exclamation-circle"></i> Error searching&hellip;<hr/><code>Error: '+data.status +' ('+data.statusText +')</code></div>');\u000a                                }\u000a                            })\u000a                            $this.data('prevAjax',xhr);\u000a                        },350);\u000a                        $this.data('keyTime',timeout);\u000a                    });\u000a\u000a                    // Build a form\u000a                    var newForm = $('<form/>').submit(function(e){\u000a                        e.preventDefault();\u000a                        return false;\u000a                    })\u000a                    var inputcontainer = $('<div class="UICIconPickHeader"/>').append(searchInput);;\u000a\u000a                    // Add color selector\u000a                    if (addColorSelector){\u000a                        var colorStyle = 'style="color:'+strcolor+'"';\u000a                        var preColor = 'value="'+strcolor+'"';\u000a                        if (strcolor == false){\u000a                            colorStyle = '';\u000a                            preColor = '';\u000a                        }\u000a                        var colorSelector = $('<label class="btn UICTabIconColorLbl" title="Set icon color"><i class="fas fa-eye-dropper" '+colorStyle+'></i><input type="color" class="UICTabIconColor btn" '+preColor+'></label>');\u000a                        colorSelector.find('.UICTabIconColor').on('change input',function(){\u000a                            $('.UICTabIconClear').removeClass('active')\u000a                            $(this).data('color',$(this).val());\u000a                            $(this).prev().css('color',$(this).val());\u000a                            $(this).closest('div.popover').find('.UICiconSearchResults').css('color',$(this).val());\u000a                        });\u000a                        inputcontainer.append(colorSelector);\u000a                        var noColor = $('<button class="btn UICTabIconClear" title="No icon color is applied"><span class="UIC-fa-stack"><i class="fas fa-slash"></i> <i class="fas fa-eye-dropper fa-stack-1x"></i></span></button>');\u000a                        noColor.on('click',function(){\u000a                            $('.UICTabIconColor').data('color',false);\u000a                            $('.UICTabIconColor').prev().css('color','inherit');\u000a                            $(this).addClass('active');\u000a                            $(this).closest('div.popover').find('.UICiconSearchResults').css('color','inherit');\u000a                        });\u000a                        if (strcolor == false){\u000a                            noColor.addClass('active');\u000a                        }\u000a                        inputcontainer.append(noColor);\u000a                        inputcontainer.addClass('input-append');\u000a                    }\u000a                    // Delete/trash\u000a                    if (addDelete){\u000a                        var delbtn = $('<button type="button" title="Dont select an icon, blank" class="btn"><i class="fas fa-trash"></i></button>');\u000a                        delbtn.on('click',function(){\u000a                            if (typeof callback == "function"){\u000a                                callback(false,false);\u000a                            }\u000a                            myself.popover('hide');\u000a                        });\u000a                        inputcontainer.append(delbtn);\u000a                        inputcontainer.addClass('input-append');\u000a                    }\u000a                    // Build it all\u000a                    newForm.append(inputcontainer).append(closebtn);\u000a                    window.setTimeout(function(){\u000a                        searchInput.focus();\u000a                        searchInput.select();\u000a                        if (addColorSelector){\u000a                            colorSelector.trigger('change');\u000a                        }\u000a                        if (defaultstr != ""){\u000a                            searchInput.trigger('keyup');\u000a                        }\u000a                    },200);\u000a                    self.logToConsole(newForm.children());\u000a                    return newForm;\u000a                },\u000a                'content': function(){\u000a                    var searchRes = $('<div class="UICiconSearchResults"><div class="text-center UICiconSearchInfo"><i class="fas fa-info-circle"></i>&nbsp;Type to search&hellip;</div></div>');\u000a                    return searchRes;\u000a                }\u000a            };\u000a        }\u000a\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        self._iconSearchBuildResults = function(jsonData,target,src,search,callback){\u000a            if (!jsonData.hasOwnProperty('data') || !jsonData.data.hasOwnProperty('search') || jsonData.data.search.length == 0){\u000a                target.html('<div class="text-center UICiconSearchInfo"><i class="fas fa-heart-broken"></i> Sorry no results found&hellip;</div>')\u000a                return true;\u000a            }\u000a            // Cleanup\u000a            target.html('');\u000a            $.each(jsonData.data.search,function(id,val){\u000a                if (!val.hasOwnProperty('id')){\u000a                    return false;\u000a                }\u000a                // Lookup free stuff only\u000a                if (val.hasOwnProperty('membership') && val.membership.hasOwnProperty('free')){\u000a                    $.each(val.membership.free,function(id2,itype){\u000a                        var itypeL = itype.slice(0,1);\u000a                        var matched = '';\u000a                        // Disabled to it didn't look good\u000a                        if (search == val.id){\u000a                        //     matched = 'class="UICIconSelected"';\u000a                        }\u000a                        target.append('<a role="button" '+matched+' href="javascript:void(0)" title="' + val.label +'"><i class="fa' + itypeL + ' fa-' + val.id +'"></i></a>');\u000a                    })\u000a                }\u000a            });\u000a\u000a            // Click handler for selecting an icon\u000a            target.find('a').off('click').on('click',function(){\u000a                var iconsel = $(this).find('i').attr('class');\u000a                // Should we trigger a callback\u000a                if (typeof callback == "function"){\u000a                    var color = null;\u000a                    var colorsel = target.closest('div.popover').find('input.UICTabIconColor');\u000a                    if (colorsel.length && colorsel.data('color') != undefined){\u000a                        color = colorsel.data('color');\u000a                    }\u000a                    callback(iconsel,color);\u000a                }\u000a                src.popover('hide');\u000a                target.find('.UICIconSelected').removeClass('UICIconSelected');\u000a                $(this).addClass('UICIconSelected');\u000a            });\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Settings handler\u000a        self.onSettingsShown = function() {\u000a            self.settingsBeenShown = true;\u000a            $('#UICReportBug').removeData('updateCheck');\u000a            $('#UICReportBug').off('click').on('click',function(){\u000a                var $this = $(this);\u000a                if ($this.data('updateCheck') == "pending"){\u000a                    return true;\u000a                }\u000a\u000a                if ($this.data('updateCheck') != "done"){\u000a                    self.logToConsole("Checking for updates to myself");\u000a                    $this.attr('disabled',true).addClass('disabled');\u000a                    $this.data('updateCheck',"pending");\u000a                    // Check for updates\u000a                    $.get("/plugin/softwareupdate/check?force=true", function(data) {\u000a                        // We have an update then show the real dialog\u000a                        if (data.hasOwnProperty('information') && data.information.hasOwnProperty('uicustomizer') && data.information.uicustomizer.updateAvailable){\u000a                            self.logToConsole("Updates found");\u000a                            new PNotify({\u000a                                title: 'Update UI Customizer<i class="fas fa-download pull-right"></i>',\u000a                                text: 'Before sending in a bug report please update to the latest version...\u005cnThanks<i class="far fa-smile-wink"></i>',\u000a                                type: "notice",\u000a                                hide: false\u000a                            });\u000a                            // Trigger the update dialog\u000a                            OctoPrint.coreui.viewmodels.softwareUpdateViewModel.performCheck(true,true,true);\u000a                        }else{\u000a                            self.logToConsole("No updates found");\u000a                            $this.data('updateCheck','done');\u000a                            $this.attr('disabled',false).removeClass('disabled');\u000a                            $this.trigger('click');\u000a                        }\u000a                    }).fail(function(){\u000a                        self.logToConsole("Update check failed");\u000a                        $this.data('updateCheck','done');\u000a                        $this.attr('disabled',false).removeClass('disabled');\u000a                        $this.trigger('click');\u000a                    }).always(function() {\u000a                        $this.data('updateCheck','done');\u000a                        $this.attr('disabled',false).removeClass('disabled');\u000a                    });\u000a                    return true;\u000a                }\u000a\u000a                // Send the bug report from here\u000a                $(this).find('i').toggleClass('skull-crossbones bug');\u000a                url = 'https://github.com/LazeMSS/OctoPrint-UICustomizer/issues/new';\u000a                var body = "## Description\u005cn**ENTER DESCRIPTION HERE\u005cnDescribe your problem?\u005cnWhat is the problem?\u005cnCan you recreate it?\u005cnDid you try disabling plugins?\u005cnDid you remember to update the subject?**\u005cn<hr>\u005cn\u005cn**Plugins installed**\u005cn";\u000a                // Get plugin info\u000a                $.each(OctoPrint.coreui.viewmodels.pluginManagerViewModel.plugins.allItems,function(x,item){\u000a                    if (item.enabled && item.bundled == false){\u000a                        var version = "";\u000a                        if (item.version != null){\u000a                            version = " v"+ item.version;\u000a                        }\u000a                        if (item.key == "uicustomizer"){\u000a                            body += '- **' + item.name +"["+item.key+"]" + version + "**\u005cn";\u000a                        }else{\u000a                            body += '- ' + item.name +"["+item.key+"]" + version + "\u005cn";\u000a                        }\u000a                    }\u000a                });\u000a                // Settings\u000a                body += "\u005cn\u005cn**UI Customizer settings**\u005cn";\u000a                $(Object.entries(OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.uicustomizer)).each(function(x,item){\u000a                    if (typeof item[1]() == "boolean"){\u000a                        body += '- ' + item[0] + ": " +item[1]() + "\u005cn";\u000a                    }\u000a                });\u000a                body += "\u005cn\u005cn**Software versions**\u005cn- "+$('#footer_version li').map(function(){return $(this).text()}).get().join("\u005cn- ");\u000a                body += "\u005cn\u005cn**Browser**\u005cn- "+navigator.userAgent\u000a                window.open(url+'?body='+encodeURIComponent(body),'UICBugReport');\u000a                $(this).blur();\u000a            });\u000a\u000a            // Widgets found\u000a            var sidebarItems = ['div.UICmainTabs'];\u000a            $('#sidebar div.accordion-group').each(function(){\u000a                sidebarItems.push('#'+$(this).attr('id'));\u000a            });\u000a\u000a            self.saved = false;\u000a            self.previewHasBeenOn = false;\u000a            var settingsPlugin = self.settings.settings.plugins.uicustomizer;\u000a\u000a            // Check for navbar\u000a            if (typeof OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.navbartemp !== "undefined"){\u000a                $('#settings_uicustomizer_general input[data-settingtype="navbarplugintempfix"]').prop( "disabled", false );\u000a            }else{\u000a                $('#settings_uicustomizer_general input[data-settingtype="navbarplugintempfix"]').prop( "disabled", true );\u000a            }\u000a\u000a            // Top icon sorting\u000a            OctoPrint.coreui.viewmodels.pluginManagerViewModel.plugins.allItems; // init it\u000a            var tiCon = $('#settings_uicustomizer_topicons_container');\u000a            tiCon.empty();\u000a            // Build item\u000a            var buildTopIconItem = function(tid){\u000a                self.logToConsole("Building sorter for: " + tid);\u000a                $thisIcon = $('#'+tid);\u000a                // Not found or already there\u000a                if (!$thisIcon.length || tiCon.find('div[data-tid="'+tid+'"]').length){\u000a                    return true;\u000a                }\u000a                var key = tid.replace('navbar_plugin_',"");\u000a                var icon = $thisIcon.find('i:first');\u000a                var iconstr = '';\u000a                // Add an icon or not?\u000a                if (icon.length){\u000a                    iconstr = icon.clone().wrap('<p>').parent().html();\u000a                }\u000a                // Get plugin data\u000a                var pdata = self.findPluginData(key);\u000a                if (pdata == null){\u000a                    var name = key.replace("_", " ").toLowerCase();\u000a                }else{\u000a                    var name = pdata.name.toLowerCase();\u000a                }\u000a                tiCon.append($('<div class="accordion-group" data-tid="'+tid+'"><div class="accordion-heading"><button class="UICDragVHandle btn btn-small" type="button" title="Sort item"><i class="fas fa-arrows-alt-v"></i></button><span class="UICPadLeft UICTopIconLbl">'+name+'</span>'+iconstr+'</div></div>'));\u000a            }\u000a\u000a            // Get the data\u000a            var sortList = settingsPlugin.topIconSort();\u000a            var topIcons = self.get_TopIcons();\u000a            $.each(sortList,function(i,item){\u000a                buildTopIconItem(item);\u000a            });\u000a            $.each(topIcons,function(i,item){\u000a                buildTopIconItem(item);\u000a            });\u000a\u000a            // sort the icons\u000a            var topIconSorter = Sortable.create(tiCon[0],{\u000a                group: 'UICTopIconSort',\u000a                draggable: 'div.accordion-group',\u000a                delay: 200,\u000a                delayOnTouchOnly: true,\u000a                sort: true,\u000a                chosenClass: 'alert-info',\u000a                direction: 'vertical',\u000a                dragoverBubble: false,\u000a                onStart: function(){\u000a                    $('#drop_overlay').addClass('UICHideHard');\u000a                },\u000a                onEnd: function(evt){\u000a                    $('#drop_overlay').removeClass('UICHideHard in');\u000a                    // prewivew sort\u000a                    if (self.previewOn){\u000a                        var newlist = $('#settings_uicustomizer_topicons_container > div').map(function(){return $(this).data('tid')}).get();\u000a                        self.set_sortTopIcons(newlist);\u000a                    }\u000a                }\u000a            })\u000a            // Store for later reference\u000a            tiCon.data('sorter',topIconSorter);\u000a\u000a\u000a            /// ---------------------- MAIN TABS\u000a\u000a            // Get the tabs data\u000a            var tabsData = self.initTabs(settingsPlugin.mainTabs());\u000a            // Build an index based lookup\u000a            var indexobj = tabsData[0];\u000a            var listItems = tabsData[1];\u000a\u000a            // Build selector - yes I could use knockout but i hate it :)\u000a            $('#settings_uicustomizer_tabs_look').empty();\u000a            $.each(listItems,function(idx,val){\u000a                // PARAMS:\u000a                // [parid,true,false,'icon','left']\u000a                // ID, Shown,Customlabel,icon class string, tab design =(true,false,iconOnly,textOnly), icon color\u000a                // 0 ,   1  ,    2      ,     3           ,      4                                    ,   5\u000a                // Build values\u000a                var target = $('#'+val).find('a');\u000a                var targetLink = target.attr('href');\u000a                var orgName = target.data('orgName');\u000a                var localObj = indexobj[val];\u000a\u000a                // Build settings for the cols\u000a                var classVis = 'fa-eye';\u000a                if (localObj[1] == false){\u000a                    classVis = "fa-eye-slash";\u000a                }\u000a                var custname = '';\u000a                if (localObj[2] != false){\u000a                    custname = localObj[2];\u000a                }\u000a                // Build colors\u000a                var color = '';\u000a                var colorData = false;\u000a                if (localObj[5] != undefined){\u000a                    colorData = localObj[5];\u000a                    color = 'style="color:'+localObj[5]+'"';\u000a                }\u000a                // Default is empty icon\u000a                var icon = 'fas fa-search UICIconEmpty';\u000a                var disbaledLI = ' disabled';\u000a                if (localObj[3] != false){\u000a                    icon = localObj[3];\u000a                    disbaledLI = '';\u000a                }else{\u000a                    color = '';\u000a                }\u000a\u000a\u000a                // Build new tabs\u000a                var newTab = $('\u005c\u000a                    <div class="control-group row-fluid UICRemoveFluidRow" data-tabid="'+val+'">\u005c\u000a                        <label class="control-label">'+orgName+'</label>\u005c\u000a                        <div class="controls">\u005c\u000a                            <div class="input-append input-prepend">\u005c\u000a                                <button class="UICDragVHandle btn" type="button" title="Sort item"><i class="fas fa-arrows-alt-v"></i></button>\u005c\u000a                                <input title="Enter tab name, blank = default" class="input-medium UICTabNameInput" placeholder="Name: '+orgName+'" type="text" value="'+custname+'">\u005c\u000a                                <button class="btn UICTabToggle" type="button" title="Hide/Show tab"><i class="fas '+classVis+'"></i></button>\u005c\u000a                                <button class="btn UICTabIcon UICShowIconPicker" type="button"><i class="'+icon+'" '+color+' data-color="'+colorData+'"></i></button><div class="btn-group">\u005c\u000a                                <ul class="dropdown-menu UICTabDesign">\u005c\u000a                                    <li class="UICTabIconReq'+disbaledLI+'"><a href="#" data-design="true"><span class="visible-phone"><i class="fas fa-align-left UICPadRight"></i><i class="fas fa-heading"></i></span><span class="hidden-phone">Icon+Text</span></a></li>\u005c\u000a                                    <li class="UICTabIconReq'+disbaledLI+'"><a href="#" data-design="false"><span class="visible-phone"><i class="fas fa-heading UICPadRight"></i><i class="fas fa-align-right"></i></span><span class="hidden-phone">Text+Icon</span></a></li>\u005c\u000a                                    <li class="UICTabIconReq'+disbaledLI+'"><a href="#" data-design="iconOnly"><i class="visible-phone fas fa-icons"></i><span class="hidden-phone">Icon only</span></a></li>\u005c\u000a                                    <li><a href="#" data-design="textOnly"><i class="visible-phone fas fa-heading"></i><span class="hidden-phone">Text only</span></a></a></li>\u005c\u000a                                </ul>\u005c\u000a                                <button class="btn dropdown-toggle" data-toggle="dropdown" title="Change view mode"><span class="UICTabIconPos"></span> <span class="caret"></span></button>\u005c\u000a                            </div>\u005c\u000a                        </div>\u005c\u000a                    </div>');\u000a\u000a                // Toggle tabs on/off\u000a                newTab.find('button.UICTabToggle').off('click').on('click',function(){\u000a                    // Hide all popovers\u000a                    $('.UICShowIconPicker').popover('hide');\u000a                    var icon = $(this).find('i');\u000a                    icon.toggleClass('fa-eye fa-eye-slash');\u000a                    if (self.previewOn){\u000a                        // Update\u000a                        var tabData = self.buildCustomTabsSave();\u000a                        self.set_mainTabsCustomize(true,tabData);\u000a                        if (icon.hasClass('fa-eye')){\u000a                            // Remove all other active\u000a                            $('.UICmainTabs .tab-pane.active').removeClass('active');\u000a                            // Set this as active\u000a                            $(target).trigger('click');\u000a                            $(targetLink).addClass('active');\u000a                        }else{\u000a                            // Trigger first visible\u000a                            $('#tabs li:not(.tabdrop) a:visible:first').trigger('click');\u000a                        }\u000a                    }\u000a                });\u000a\u000a                // Change tab text\u000a                newTab.find('input.UICTabNameInput').off('blur keyup').on('blur keyup',function(){\u000a                    // Hide all popovers\u000a                    $('.UICShowIconPicker').popover('hide');\u000a                    if (self.previewOn){\u000a                        // Update\u000a                        var tabData = self.buildCustomTabsSave();\u000a                        self.set_mainTabsCustomize(true,tabData);\u000a                    }\u000a                });\u000a\u000a                // Change tab icon\u000a                var newIconSrc = newTab.find('button.UICTabIcon >i');\u000a                newTab.find('button.UICTabIcon').removeData("frun").popover(\u000a                    self.iconSearchPopover(newIconSrc,function(newicon,newcolor){\u000a                        if (newcolor == null || newicon == false){\u000a                            newcolor = false;\u000a                        }\u000a                        newIconSrc.data('color',newcolor);\u000a                        // Delete\u000a                        if (newicon === false){\u000a                            newTab.find('li.UICTabIconReq').addClass('disabled');\u000a                            newTab.find('ul.UICTabDesign li:not(.UICTabIconReq) a').trigger('click');\u000a                            newIconSrc.attr('class','fas fa-search UICIconEmpty');\u000a                            newIconSrc.css({'color':''});\u000a                        }else{\u000a                            newTab.find('ul.UICTabDesign li.UICTabIconReq').removeClass('disabled');\u000a                            newIconSrc.attr('class',newicon);\u000a                            if (newcolor != false){\u000a                                newIconSrc.css({'color':newcolor});\u000a                            }else{\u000a                                newIconSrc.css({'color':''});\u000a                            }\u000a                        }\u000a                        if (self.previewOn){\u000a                             // Update\u000a                            var tabData = self.buildCustomTabsSave();\u000a                            self.set_mainTabsCustomize(true,tabData);\u000a                        }\u000a                    },true,true,newIconSrc,'#settings_uicustomizer_tabs','left')\u000a                ).attr('Title','Click to change icon');\u000a\u000a\u000a                // Change icon design\u000a                newTab.find('button.dropdown-toggle').off('click').on('click',function(){\u000a                     // Hide all popovers\u000a                    $('.UICShowIconPicker').popover('hide');\u000a                });\u000a                newTab.find('ul.UICTabDesign li a').off('click').on('click',function(event,force){\u000a                    if (force !== true && $(this).parent().hasClass('disabled')){\u000a                        return true;\u000a                    }\u000a                    newTab.find('ul.UICTabDesign li.active').removeClass('active');\u000a                    $(this).parent().addClass('active');\u000a                    newTab.find('span.UICTabIconPos').html($(this).html());\u000a                    if (self.previewOn){\u000a                        // Update\u000a                        var tabData = self.buildCustomTabsSave();\u000a                        self.set_mainTabsCustomize(true,tabData);\u000a                    }\u000a                });\u000a\u000a                // Add to the UI\u000a                $('#settings_uicustomizer_tabs_look ').append(newTab);\u000a\u000a                // update selector\u000a                newTab.find('ul.UICTabDesign li a[data-design="'+localObj[4].toString()+'"]').trigger('click',[true]);\u000a            })\u000a\u000a            // sort the tabs\u000a            var tabsorter = Sortable.create($('#settings_uicustomizer_tabs_look')[0],{\u000a                group: 'UICTabSort',\u000a                draggable: 'div.control-group',\u000a                delay: 200,\u000a                delayOnTouchOnly: true,\u000a                sort: true,\u000a                chosenClass: 'alert-info',\u000a                handle: '.UICDragVHandle',\u000a                direction: 'vertical',\u000a                dragoverBubble: false,\u000a                onStart: function(){\u000a                    $('#drop_overlay').addClass('UICHideHard');\u000a                },\u000a                onEnd: function(evt){\u000a                    $('#drop_overlay').removeClass('UICHideHard in');\u000a                    if (self.previewOn){\u000a                        var tabData = self.buildCustomTabsSave();\u000a                        self.set_mainTabsCustomize(true,tabData);\u000a                    }\u000a                }\u000a            })\u000a            // Store for later reference\u000a            $('#settings_uicustomizer_tabs_look').data('sorter',tabsorter);\u000a\u000a            // Toggle main customizing on/off\u000a            $('#UICMainTabCustomizerToggle').off('change').on('change',function(){\u000a                if ($(this).is(':checked')){\u000a                    // Check for themify\u000a                    if (typeof OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.themeify == "object" && OctoPrint.coreui.viewmodels.settingsViewModel.settings.plugins.themeify.tabs.enableIcons()){\u000a                        $('.UICthemeifyAlert').fadeIn();\u000a                    }else{\u000a                        $('.UICthemeifyAlert').hide();\u000a                    }\u000a                    tabsorter.option("disabled", false);\u000a                    $('#settings_uicustomizer_tabs_look').fadeTo(300,1);\u000a                    $('#settings_uicustomizer_tabs_look :input').prop( "disabled", false );\u000a                    if (self.previewOn){\u000a                        var tabData = self.buildCustomTabsSave();\u000a                        self.set_mainTabsCustomize(true,tabData);\u000a                    }\u000a                }else{\u000a                    $('.UICthemeifyAlert').hide();\u000a                    tabsorter.option("disabled", true);\u000a                    $('#settings_uicustomizer_tabs_look').fadeTo(300,0.5);\u000a                    $('#settings_uicustomizer_tabs_look :input').prop( "disabled", true );\u000a                    if (self.previewOn){\u000a                        self.set_mainTabsCustomize(false,false);\u000a                    }\u000a                }\u000a            });\u000a            if (!$('#UICMainTabCustomizerToggle').is(':checked')){\u000a                $('#UICMainTabCustomizerToggle').trigger('change');\u000a            }else{\u000a                $('.UICthemeifyAlert').hide();\u000a            }\u000a            // Hook into themifiy settings\u000a            if ($('input[data-bind="checked: tabIcons.enabled"]').length){\u000a                $('input[data-bind="checked: tabIcons.enabled"]').off('change.UICThem').on('change.UICThem',function(){\u000a                    $('#UICMainTabCustomizerToggle').trigger('change');\u000a                });\u000a            }\u000a\u000a            /// ---------------------- COLS LAYOUT\u000a\u000a            // Cleanup\u000a            $('#UICSortCols ul li').remove();\u000a            $('#UICSortCols ul').addClass('nav-tabs'); // hack due to this: https://github.com/OctoPrint/OctoPrint/blob/3ab84ed7e4c3aaaf71fe0f184b465f25d689f929/src/octoprint/static/js/app/main.js#L737\u000a\u000a            // Build the sorter to make it ready\u000a            var colsTemp = settingsPlugin.rows();\u000a\u000a            // Join and filter on unique values\u000a            sidebarItems = sidebarItems.concat(Object.keys(self.customWidgets)).filter(function(value, index, self) {\u000a                    return self.indexOf(value) === index;\u000a            });\u000a            self.logToConsole("Sidebar and custom widgets:" + JSON.stringify([...sidebarItems]));\u000a\u000a            // Run trough each col\u000a            $(colsTemp).each(function(colid,items){\u000a                // Skip if broken\u000a                if (typeof items != "object"){\u000a                    return;\u000a                }\u000a                // add to the editor\u000a                $.each(items, function(widgetid,shown){\u000a                    if (typeof widgetid != "string"){\u000a                        return;\u000a                    }\u000a                    // prefix removal\u000a                    if (widgetid.charAt(0) == "_"){\u000a                        self.logToConsole("Slicing 3 chars of: " + widgetid);\u000a                        widgetid = widgetid.slice(3);\u000a                        self.logToConsole("new widgetid: " + widgetid);\u000a                    }\u000a                    // This is bad\u000a                    if ($(widgetid).length == 0){\u000a                        self.logToConsole("Skipping widgetid: " + widgetid + ", not found");\u000a                        return;\u000a                    }\u000a                    if (typeof shown == "function"){\u000a                        shown = shown();\u000a                    }\u000a                    self.logToConsole('Adding widget "' + widgetid + '"('+shown + ") to selector");\u000a                    self.addToSorter(colid,widgetid,shown);\u000a                    // Remove from add defaults\u000a                    var arpos = $.inArray(widgetid,sidebarItems);\u000a                    if (arpos >= 0){\u000a                        self.logToConsole('Removing widget "' + widgetid + '" from sidebarItems');\u000a                        sidebarItems.splice(arpos, 1);\u000a                    }\u000a                });\u000a            });\u000a\u000a            // Append the missing items from the initial load items\u000a            if(sidebarItems.length >0){\u000a                $(sidebarItems).each(function(key,val){\u000a                    self.logToConsole('Adding non-placed widget "'+ val+'"');\u000a                    self.addToSorter(0,val,false);\u000a                })\u000a            }\u000a\u000a            // Hide/show widget\u000a            $('#UICSortCols ul > li> a  > i.UICToggleVis').off('click').on('click',function(event){\u000a                $(this).toggleClass('fa-eye fa-eye-slash');\u000a                var granpar = $(this).parent().parent();\u000a                // Change checkbox\u000a                var chbox = granpar.find('input');\u000a                chbox.prop("checked", !chbox.prop("checked"));\u000a                if (self.previewOn){\u000a                    $($(this).closest('li').data('id')).toggleClass('UICHide');\u000a                    self.previewHasBeenOn = true;\u000a                }\u000a                granpar.addClass('UICPreviewRestore');\u000a                event.stopPropagation();\u000a            });\u000a\u000a            // Update min max\u000a            var fixMinMax = function(){\u000a                // Update min/max for all items and disable the last one\u000a                $('#UICSortCols ul:empty').parent().find('input.uiccolwidth').attr('min',0);\u000a                $('#UICSortCols ul:not(:empty)').parent().find('input.uiccolwidth').attr('min',1);\u000a                $('#UICSortCols ul').parent().find('input.uiccolwidth').attr('max',(10+$('#UICSortCols ul:empty').length));\u000a                $('#UICSortCols ul:last:empty').parent().find('input.uiccolwidth').val(0).prop('disabled',true);\u000a                $('#UICSortCols ul:last:not(:empty)').parent().find('input.uiccolwidth').prop('disabled',false);\u000a                $('#settings_plugin_uicustomizer input.uiccolwidth').trigger('input');\u000a            }\u000a\u000a            // Sort/draghandler layout\u000a            $('#UICSortCols ul').each(function(key,val){\u000a                self.SortableSet[key] = Sortable.create(this,{\u000a                    group: 'UICsortList',\u000a                    draggable: 'li',\u000a                    filter: "i.UICToggleVis",\u000a                    delay: 200,\u000a                    delayOnTouchOnly: true,\u000a                    sort: true,\u000a                    dragoverBubble: false,\u000a                    onStart: function(){\u000a                        $('#drop_overlay').addClass('UICHideHard');\u000a                    },\u000a                    onEnd: function(evt){\u000a                        $('#drop_overlay').removeClass('UICHideHard in');\u000a                        // Update min/max for all items\u000a                        fixMinMax();\u000a                        // Preview\u000a                        if (self.previewOn){\u000a                            var colData = self.buildColumns(false);\u000a                            self.set_mainLayout({'rows': colData[0],'widths':colData[1]});\u000a                        }\u000a                    }\u000a                });\u000a            });\u000a\u000a            // width settings updater\u000a            $('#settings_plugin_uicustomizer input.uiccolwidth').off('input.uicus').on('input.uicus',function(){\u000a                $(this).next().html($(this).val());\u000a            });\u000a\u000a            // Keep the maxium width\u000a            $('#settings_plugin_uicustomizer input.uiccolwidth').off('change.uicus').on('change.uicus',function(){\u000a                var thisItem = this;\u000a                var spanW = $('#UICSortCols input.uiccolwidth');\u000a\u000a                var totalspan = spanW.map(function(){return $(this).val();}).get().reduce(function(a, b){\u000a                    return parseInt(a,10) + parseInt(b,10);\u000a                }, 0);\u000a\u000a                // Over?\u000a                if (totalspan > self.maxCWidth){\u000a                    var diff = totalspan - self.maxCWidth;\u000a                    $(spanW).each(function(key,item){\u000a                        if (item != thisItem){\u000a                            var thisVal = parseInt($(item).val(),10);\u000a                            var thisDiff = (thisVal-diff);\u000a\u000a                            // To much diff?\u000a                            if(thisDiff < 1){\u000a                                diff -= (thisVal-1);\u000a                                $(item).val(1).trigger('input');\u000a                            }else{\u000a                                diff -= thisDiff;\u000a                                $(item).val(thisDiff).trigger('input');\u000a                            }\u000a                            // No more needed\u000a                            if (diff <= 0){\u000a                                return false;\u000a                            }\u000a                        }\u000a                    });\u000a                    spanW.trigger('input');\u000a                }\u000a                // Preview\u000a                if (self.previewOn){\u000a                    var colData = self.buildColumns(false);\u000a                    self.set_mainLayout({'rows': colData[0],'widths':colData[1]});\u000a                }\u000a            });\u000a\u000a            // Set all empty to minimum\u000a            fixMinMax();\u000a\u000a            // Hide icon pickers\u000a            $('#settings_plugin_uicustomizer ul.nav.nav-pills a').off('click.uicus').on('click.uicus',function(){\u000a                $('.UICShowIconPicker').popover('hide');\u000a            });\u000a\u000a            // Toggle preview on/off\u000a            self.previewOn = false;\u000a            $('#UICRealPrevCheck').off('click.uicusPrev').on('click.uicusPrev',function(){\u000a                // Toggle icon\u000a                $(this).find('i').toggleClass('fa-square fa-check-square');\u000a                // Set status\u000a                self.previewOn = !self.previewOn;\u000a                $('body').toggleClass('UICPreviewON');\u000a                $(window).trigger('resize');\u000a\u000a                if (self.previewOn){\u000a                    self.previewHasBeenOn = true;\u000a                    // Update all\u000a                    $('#settings_plugin_uicustomizer input:checkbox[data-settingtype]').trigger('change.uicus');\u000a                    var colData = self.buildColumns(false);\u000a                    self.set_mainLayout({'rows': colData[0],'widths':colData[1]});\u000a\u000a                    // Trigger us self if checking anything but our own menu item\u000a                    $('#settingsTabs a, #UICsettingsMenu a:not(.dropdown-toggle)').not('#settings_plugin_uicustomizer_link a').off('click.uicusPrev').one('click.uicusPrev',function(){\u000a                        $('.UICShowIconPicker').popover('hide');\u000a                        if (self.previewOn){\u000a                            $('#UICRealPrevCheck').trigger('click.uicusPrev');\u000a                        }\u000a                    });\u000a\u000a                    // Update main tabs\u000a                    $('#UICMainTabCustomizerToggle').trigger('change');\u000a\u000a                    // Show all top icons to preview\u000a                    if ($('ul.UICHeaderIcons').length){\u000a                        $('ul.UICHeaderIcons >li a:hidden').addClass('UICpreviewHide').show();\u000a                    }else{\u000a                        $('div.UICMainMenu ul.nav >li a:hidden').addClass('UICpreviewHide').show();\u000a                    }\u000a\u000a                }else{\u000a                    // Remove preview toggles and restore the views when turning preview off/on\u000a                    if (self.previewHasBeenOn){\u000a                        $('.UICPreviewRestore[data-orgvis]').each(function(){\u000a                            var item = $($(this).data('id'))\u000a                            if ($(this).data('orgvis')){\u000a                                item.removeClass('UICHide');\u000a                            }else{\u000a                                item.addClass('UICHide');\u000a                            }\u000a                        });\u000a                        $('.UICpreviewHide').hide();\u000a                        $('.UICpreviewHide').removeClass('UICpreviewHide');\u000a                    }\u000a                    $('#settingsTabs').off('click.uicusPrev');\u000a                }\u000a            }).find('i').removeClass('fa-check-square').addClass('fa-square');\u000a\u000a\u000a            // Realtime preview\u000a            $('#settings_plugin_uicustomizer input:checkbox[data-settingtype]').on('change.uicus',function(){\u000a                var settingType = $(this).data('settingtype');\u000a                if (self.previewOn && typeof self['set_'+settingType] == "function"){\u000a                    self['set_'+settingType]($(this).is(':checked'));\u000a                    if ($(this).data('previewtab') !== null){\u000a                        $('#'+$(this).data('previewtab')+ ' a').trigger('click');\u000a                    }\u000a                 }\u000a            });\u000a        }\u000a\u000a         // ------------------------------------------------------------------------------------------------------------------------\u000a        // Add an item to settings UI\u000a        self.addToSorter = function(col,item,visible){\u000a            var accord = $(item+' div.accordion-heading a.accordion-toggle').clone();\u000a            var icon = accord.find('i');\u000a            var title = $.trim(accord.text());\u000a            if (title == "" && self.nameLookup.hasOwnProperty(item)){\u000a                accord = $('<a>').append(self.nameLookup[item]);\u000a                icon = accord.find('i');\u000a                title = $.trim(accord.text());\u000a            }\u000a            if (title == ""){\u000a                if ($(item).attr('id') != undefined){\u000a                    title = $(item).attr('id')+"";\u000a                }else{\u000a                    title= "Unknown";\u000a                }\u000a            }\u000a            if (title.length > 25){\u000a                title = title.slice(0,25)+"&hellip;";\u000a            }\u000a\u000a             // Set checkbox and eye icon\u000a            var checked = '';\u000a            var checkclass = 'fa-eye-slash'\u000a            if (visible || $(item).is(':visible')){\u000a                checked = ' checked';\u000a                checkclass = 'fa-eye';\u000a            }\u000a\u000a            // Main tabs can't be skinned\u000a            if (item == "div.UICmainTabs"){\u000a               $($('#UICSortCols ul')[col]).append(\u000a                    $('<li data-id="'+item+'" data-orgvis="'+visible+'"><a><i class="'+icon.attr('class')+' UICPadRight"></i>'+title+'<i class="pull-right fas '+checkclass+' UICToggleVis"></i></a><input class="hide" type="checkbox"'+checked+'></li>')\u000a                );\u000a            }else{\u000a                $($('#UICSortCols ul')[col]).append(\u000a                    $('<li data-id="'+item+'" data-orgvis="'+visible+'"><a><i class="'+icon.attr('class')+' UICPadRight"></i>'+title+'<i class="pull-right fas '+checkclass+' UICToggleVis"></i></a><input class="hide" type="checkbox"'+checked+'></li>')\u000a                );\u000a            }\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // Save handler and update\u000a        self.onSettingsBeforeSave = function () {\u000a            // Update if we have been shown/edited\u000a            if (self.settingsBeenShown){\u000a                if (typeof self.settings.settings.plugins.navbartemp !== "undefined" && self.settings.settings.plugins.uicustomizer.navbarplugintempfix()){\u000a                    self.settings.settings.plugins.navbartemp.useShortNames(true);\u000a                }\u000a\u000a                // Get the data\u000a                self.saved = true;\u000a                var colData = self.buildColumns(true);\u000a                if (colData[0]().length == 0 || $.isEmptyObject(colData[0]()[0])){\u000a                    console.log(colData);\u000a                    alert("Critical failure saving UI Customizer settings - not saved!\u005cnPlease look in the developer console.");\u000a                    return false;\u000a                }\u000a                var topIconsSort = $('#settings_uicustomizer_topicons_container > div').map(function(){return $(this).data('tid')}).get();\u000a\u000a                // Save and update\u000a                self.settings.settings.plugins.uicustomizer.topIconSort = ko.observableArray(topIconsSort);\u000a                self.settings.settings.plugins.uicustomizer.rows = colData[0];\u000a                self.settings.settings.plugins.uicustomizer.widths = colData[1];\u000a                self.settings.settings.plugins.uicustomizer.mainTabsCustomize = ko.observable($('#UICMainTabCustomizerToggle').is(':checked'));\u000a                self.settings.settings.plugins.uicustomizer.mainTabs = ko.observableArray(self.buildCustomTabsSave());\u000a\u000a                var streamURL = self.settings.webcam_streamUrl();\u000a                if (/.m3u8/i.test(streamURL)){\u000a                    $('#webcam_container img').attr('src','data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7');\u000a                    $('#webcam_container').hide();\u000a                }else{\u000a                    $('#webcam_hls_container video').attr('src','');\u000a                    $('#webcam_hls_container').hide();\u000a                }\u000a\u000a                self.logToConsole(" ----> Settings have been saved/updated <----");\u000a            }\u000a        }\u000a\u000a        self.fromCurrentData = function(data){\u000a            if (!self.getReturnData) return;\u000a\u000a            // Gcode widget on and visible\u000a            if (!$('#UICGcodeVWidgetContainer.collapse.in').length || !$('#gcode_canvas').length || typeof OctoPrint.coreui.viewmodels.gcodeViewModel != "object") return;\u000a\u000a            // load the file is needed\u000a            if (OctoPrint.coreui.viewmodels.gcodeViewModel.needsLoad){\u000a                OctoPrint.coreui.viewmodels.gcodeViewModel.loadFile(OctoPrint.coreui.viewmodels.gcodeViewModel.selectedFile.path(), OctoPrint.coreui.viewmodels.gcodeViewModel.selectedFile.date());\u000a            }\u000a\u000a            // Update if gcode if not centered\u000a            if (OctoPrint.coreui.selectedTab !== "#gcode") OctoPrint.coreui.viewmodels.gcodeViewModel._renderPercentage(data.progress.completion);\u000a\u000a            // Make a clone and parse to\u000a            var clone = $('#UICGcodeVWidgetCan')[0];\u000a            var clonecon = clone.getContext('2d');\u000a            var source = $('#gcode_canvas')[0];\u000a            var factor = $('#UICGcodeVWidget').data('zoomlvl');\u000a            clone.width = source.width/factor\u000a            clone.height = source.height/factor\u000a            clonecon.drawImage( source, 0, 0, clone.width, clone.height);\u000a        }\u000a\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a        // When settings are hidden\u000a        self.onSettingsHidden = function() {\u000a            self.settingsBeenShown = false;\u000a            // Revert if not saved and we have been previewing anything\u000a            if (!self.saved && self.previewHasBeenOn){\u000a                self.previewHasBeenOn = false;\u000a                // Cancel the data to revert settings\u000a                OctoPrint.coreui.viewmodels.settingsViewModel.cancelData();\u000a            }\u000a            // Update\u000a            self.UpdateLayout(self.settings.settings.plugins.uicustomizer);\u000a\u000a            // Always hide previewed stuff\u000a            $('.UICpreviewHide').hide();\u000a            $('.UICpreviewHide').removeClass('UICpreviewHide');\u000a            // Remove preview\u000a            $('body').removeClass('UICPreviewON');\u000a\u000a            // Remove sorts\u000a            $(self.SortableSet).each(function(){\u000a                this.destroy();\u000a            });\u000a\u000a            $('#settings_uicustomizer_topicons_container').data('sorter').destroy();\u000a            $('#settings_uicustomizer_topicons_container').removeData('sorter');\u000a            // Remove sorter on tabs\u000a            $('#settings_uicustomizer_tabs_look').data('sorter').destroy();\u000a            $('#settings_uicustomizer_tabs_look').removeData('sorter');\u000a            // Cleanup to prevent listners etc\u000a            $('#settings_uicustomizer_tabs_look').empty();\u000a            // Remove popovers\u000a            $('.UICShowIconPicker').popover('hide');\u000a            $('#settings_uicustomizer_tabs div.popover').remove();\u000a\u000a\u000a            // Trigger\u000a            $('#tabs').trigger('resize');\u000a\u000a            // Disable event listners\u000a            $('#settings_plugin_uicustomizer input').off('input.uicus change.uicus click.uicus');\u000a        }\u000a\u000a        // ------------------------------------------------------------------------------------------------------------------------\u000a\u000a        self.findPluginData = function(pluginKey){\u000a            var returnItem = null;\u000a            $.each(OctoPrint.coreui.viewmodels.pluginManagerViewModel.plugins.allItems,function(x,item){\u000a                if (item.key == pluginKey){\u000a                    returnItem = item;\u000a                    return false;\u000a                }\u000a            });\u000a            return returnItem;\u000a        }\u000a\u000a    }\u000a\u000a    // This is how our plugin registers itself with the application, by adding some configuration information to\u000a    // the global variable ADDITIONAL_VIEWMODELS\u000a    OCTOPRINT_VIEWMODELS.push([\u000a        // This is the constructor to call for instantiating the plugin\u000a        UICustomizerViewModel,\u000a\u000a        // This is a list of dependencies to inject into the plugin, the order which you request here is the order\u000a        // in which the dependencies will be injected into your view model upon instantiation via the parameters\u000a        // argument\u000a        ["settingsViewModel"],\u000a\u000a        // Finally, this is the list of all elements we want this view model to be bound to.\u000a        []\u000a    ]);\u000a});\u000a\u000a/* UICustomizer END */\u000a\u000a;\u000a
p0
.